<!-- Enhanced AI Assistant with GPT-4 Integration -->
<div class="enhanced-ai-assistant" id="enhanced-ai-assistant">
    <!-- AI Assistant Toggle Button (Bottom Right) -->
    <button class="ai-assistant-toggle" 
            id="ai-assistant-toggle"
            type="button"
            aria-label="Open AI Assistant Chat"
            title="AI Assistant - Customer Service & Support">
        <i class="fas fa-robot" aria-hidden="true"></i>
        <span class="ai-notification-dot" id="ai-notification-dot" style="display: none;"></span>
    </button>

    <!-- AI Chat Window (Expandable from bottom-right) -->
    <div class="ai-chat-window" id="ai-chat-window" style="display: none;">
        <!-- Drag Handle for Moving -->
        <div class="ai-drag-handle" id="ai-drag-handle">
            <i class="fas fa-grip-horizontal"></i>
        </div>
        
        <!-- Chat Header -->
        <div class="ai-chat-header">
            <div class="ai-header-info">
                <div class="ai-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="ai-status-info">
                    <h6 class="ai-title">AI Assistant</h6>
                    <span class="ai-status" id="ai-status">Ready to help</span>
                </div>
            </div>
            <div class="ai-header-controls">
                <button class="ai-btn ai-btn-sm" id="ai-clear-conversation" title="Clear conversation">
                    <i class="fas fa-broom"></i>
                </button>
                <button class="ai-btn ai-btn-sm" id="ai-resize-toggle" title="Toggle size">
                    <i class="fas fa-expand-arrows-alt"></i>
                </button>
                <button class="ai-btn ai-btn-sm" id="ai-minimize" title="Minimize">
                    <i class="fas fa-minus"></i>
                </button>
                <button class="ai-btn ai-btn-sm" id="ai-close" title="Close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="ai-quick-actions" id="ai-quick-actions">
            <div class="quick-action-group">
                <h7>Quick Actions:</h7>
                <div class="quick-action-buttons">
                    <button class="quick-action-btn" data-action="search">
                        <i class="fas fa-search"></i> Start Search
                    </button>
                    <button class="quick-action-btn" data-action="view-assets">
                        <i class="fas fa-images"></i> View Assets
                    </button>
                    <button class="quick-action-btn" data-action="account-info">
                        <i class="fas fa-user"></i> Account Info
                    </button>
                    <button class="quick-action-btn" data-action="help">
                        <i class="fas fa-question-circle"></i> Help
                    </button>
                </div>
            </div>
        </div>

        <!-- Chat Messages Container -->
        <div class="ai-chat-messages" id="ai-chat-messages">
            <div class="ai-welcome-message">
                <div class="ai-message">
                    <div class="ai-message-avatar">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="ai-message-content">
                        <div class="ai-message-text">
                            üëã <strong>Welcome to Enhanced Media Scraper AI Assistant!</strong><br><br>
                            I'm your intelligent customer service and support assistant. I can help you with:
                            <ul>
                                <li>üîç <strong>Search & Download:</strong> "Start a search for cats" or "Search Instagram for @username"</li>
                                <li>üìÇ <strong>Asset Management:</strong> "Delete all my images" or "Show my recent downloads"</li>
                                <li>‚öôÔ∏è <strong>Account & Settings:</strong> Check credits, subscription plans, usage statistics</li>
                                <li>‚ùì <strong>Support:</strong> Troubleshooting, how-to guides, feature explanations</li>
                            </ul>
                            üí° <em>Try saying something like "delete all of my images" or "start a search for nature photos"</em>
                        </div>
                        <div class="ai-message-time">Just now</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat Input -->
        <div class="ai-chat-input-container">
            <div class="ai-input-wrapper">
                <textarea class="ai-chat-input" 
                          id="ai-chat-input"
                          placeholder="Ask me anything about media scraping, your account, or say commands like 'delete all of my images'..."
                          rows="1"
                          maxlength="1000"></textarea>
                <button class="ai-send-btn" id="ai-send-btn" type="button" disabled>
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
            <div class="ai-input-footer">
                <div class="ai-powered-by">
                    <i class="fas fa-brain text-primary"></i> Powered by GPT-4
                </div>
                <div class="ai-char-counter">
                    <span id="ai-char-count">0</span>/1000
                </div>
            </div>
        </div>

        <!-- Typing Indicator -->
        <div class="ai-typing-indicator" id="ai-typing-indicator" style="display: none;">
            <div class="ai-message">
                <div class="ai-message-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="ai-message-content">
                    <div class="ai-typing-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- API Key Modal -->
<div class="modal fade" id="ai-api-key-modal" tabindex="-1" aria-labelledby="ai-api-key-modal-label" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="ai-api-key-modal-label">
                    <i class="fas fa-key text-primary"></i> OpenAI API Key Required
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> 
                    To use the AI Assistant, you need to provide your OpenAI API key. This key is stored locally in your browser and is never sent to our servers.
                </div>
                <form id="ai-api-key-form">
                    <div class="mb-3">
                        <label for="ai-api-key-input" class="form-label">OpenAI API Key</label>
                        <input type="password" 
                               class="form-control" 
                               id="ai-api-key-input" 
                               placeholder="sk-..." 
                               required>
                        <div class="form-text">
                            Get your API key from <a href="https://platform.openai.com/api-keys" target="_blank">OpenAI Dashboard</a>
                        </div>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="ai-api-key-remember">
                        <label class="form-check-label" for="ai-api-key-remember">
                            Remember API key in browser
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="ai-api-key-save">
                    <i class="fas fa-save"></i> Save API Key
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Enhanced AI Assistant Styles -->
<style>
.enhanced-ai-assistant {
    position: fixed;
    z-index: 9999;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

/* Toggle Button (Bottom Right) */
.ai-assistant-toggle {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    color: white;
    font-size: 24px;
    cursor: pointer;
    box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    transform-origin: center;
}

.ai-assistant-toggle:hover {
    transform: translateY(-3px) scale(1.05);
    box-shadow: 0 8px 30px rgba(102, 126, 234, 0.6);
    background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
}

.ai-assistant-toggle:active {
    transform: translateY(-1px) scale(0.95);
}

/* Animation states for expanding/collapsing */
.ai-assistant-toggle.expanding {
    animation: expandToChat 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
}

.ai-assistant-toggle.collapsing {
    animation: collapseToCircle 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
}

@keyframes expandToChat {
    0% {
        transform: scale(1);
        border-radius: 50%;
    }
    50% {
        transform: scale(1.1);
        border-radius: 30%;
    }
    100% {
        transform: scale(0);
        border-radius: 16px;
        opacity: 0;
    }
}

@keyframes collapseToCircle {
    0% {
        transform: scale(0);
        border-radius: 16px;
        opacity: 0;
    }
    50% {
        transform: scale(1.1);
        border-radius: 30%;
    }
    100% {
        transform: scale(1);
        border-radius: 50%;
        opacity: 1;
    }
}

.ai-notification-dot {
    position: absolute;
    top: 8px;
    right: 8px;
    width: 12px;
    height: 12px;
    background: #ff4757;
    border-radius: 50%;
    border: 2px solid white;
    animation: notification-pulse 2s infinite;
}

@keyframes notification-pulse {
    0%, 100% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.2); opacity: 0.8; }
}

/* Chat Window (Bottom Right) */
.ai-chat-window {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 420px;
    max-height: 600px;
    background: var(--bg-primary, #ffffff);
    border: 1px solid var(--border-color, #dee2e6);
    border-radius: 16px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    z-index: 9998;
    backdrop-filter: blur(10px);
    transform-origin: bottom right;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Chat window animation states */
.ai-chat-window.appearing {
    animation: chatAppear 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
}

.ai-chat-window.disappearing {
    animation: chatDisappear 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
}

@keyframes chatAppear {
    0% {
        transform: scale(0) translateY(20px);
        opacity: 0;
    }
    50% {
        transform: scale(1.05) translateY(-5px);
        opacity: 0.8;
    }
    100% {
        transform: scale(1) translateY(0);
        opacity: 1;
    }
}

@keyframes chatDisappear {
    0% {
        transform: scale(1) translateY(0);
        opacity: 1;
    }
    50% {
        transform: scale(0.95) translateY(10px);
        opacity: 0.5;
    }
    100% {
        transform: scale(0) translateY(20px);
        opacity: 0;
    }
}

/* Chat Header */
.ai-chat-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 16px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-radius: 16px 16px 0 0;
}

.ai-header-info {
    display: flex;
    align-items: center;
    gap: 12px;
}

.ai-avatar {
    width: 40px;
    height: 40px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
}

.ai-title {
    margin: 0;
    font-size: 16px;
    font-weight: 600;
}

.ai-status {
    font-size: 12px;
    opacity: 0.9;
    margin: 0;
}

.ai-header-controls {
    display: flex;
    gap: 8px;
}

.ai-btn {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: white;
    border-radius: 6px;
    padding: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    min-width: 30px;
    min-height: 30px;
}

.ai-btn:hover {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.4);
}

.ai-btn-sm {
    padding: 4px;
    min-width: 26px;
    min-height: 26px;
    font-size: 12px;
}

/* Quick Actions */
.ai-quick-actions {
    padding: 12px 16px;
    border-bottom: 1px solid var(--border-light, #f1f3f4);
    background: var(--bg-secondary, #f8f9fa);
}

.quick-action-group h7 {
    font-size: 12px;
    font-weight: 600;
    color: var(--text-secondary, #6c757d);
    margin: 0 0 8px 0;
    display: block;
}

.quick-action-buttons {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
}

.quick-action-btn {
    background: var(--bg-primary, #ffffff);
    border: 1px solid var(--border-color, #dee2e6);
    color: var(--text-primary, #333);
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 11px;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 4px;
}

.quick-action-btn:hover {
    background: #667eea;
    color: white;
    border-color: #667eea;
    transform: translateY(-1px);
}

/* Chat Messages */
.ai-chat-messages {
    flex: 1;
    padding: 16px;
    max-height: 350px;
    overflow-y: auto;
    min-height: 200px;
}

.ai-message {
    display: flex;
    gap: 12px;
    margin-bottom: 16px;
}

.ai-message-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: var(--bg-secondary, #f8f9fa);
    color: #667eea;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    flex-shrink: 0;
}

.user-message .ai-message-avatar {
    background: #667eea;
    color: white;
}

.ai-message-content {
    flex: 1;
    min-width: 0;
}

.ai-message-text {
    background: var(--bg-secondary, #f8f9fa);
    padding: 12px 16px;
    border-radius: 18px;
    font-size: 14px;
    line-height: 1.5;
    word-wrap: break-word;
    color: var(--text-primary, #333);
}

.user-message .ai-message-text {
    background: #667eea;
    color: white;
}

.ai-message-text ul {
    margin: 8px 0;
    padding-left: 20px;
}

.ai-message-text ul li {
    margin: 4px 0;
}

.ai-message-text strong {
    font-weight: 600;
}

.ai-message-time {
    font-size: 11px;
    color: var(--text-muted, #6c757d);
    margin-top: 4px;
    padding: 0 16px;
}

/* Chat Input */
.ai-chat-input-container {
    border-top: 1px solid var(--border-light, #f1f3f4);
    padding: 16px;
}

.ai-input-wrapper {
    display: flex;
    gap: 8px;
    align-items: flex-end;
}

.ai-chat-input {
    flex: 1;
    border: 1px solid var(--border-color, #dee2e6);
    border-radius: 20px;
    padding: 12px 16px;
    font-size: 14px;
    resize: none;
    max-height: 100px;
    min-height: 44px;
    background: var(--bg-primary, #ffffff);
    color: var(--text-primary, #333);
}

.ai-chat-input:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.ai-send-btn {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    background: #667eea;
    border: none;
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    flex-shrink: 0;
}

.ai-send-btn:disabled {
    background: #dee2e6;
    cursor: not-allowed;
}

.ai-send-btn:not(:disabled):hover {
    background: #5a6fd8;
    transform: translateY(-1px);
}

.ai-input-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 8px;
}

.ai-powered-by {
    font-size: 11px;
    color: var(--text-muted, #6c757d);
    display: flex;
    align-items: center;
    gap: 4px;
}

.ai-char-counter {
    font-size: 11px;
    color: var(--text-muted, #6c757d);
}

/* Typing Indicator */
.ai-typing-dots {
    display: flex;
    gap: 4px;
    padding: 12px 16px;
}

.ai-typing-dots span {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #667eea;
    animation: typing-bounce 1.4s infinite ease-in-out;
}

.ai-typing-dots span:nth-child(2) {
    animation-delay: 0.2s;
}

.ai-typing-dots span:nth-child(3) {
    animation-delay: 0.4s;
}

@keyframes typing-bounce {
    0%, 80%, 100% {
        transform: scale(0.8);
        opacity: 0.5;
    }
    40% {
        transform: scale(1);
        opacity: 1;
    }
}

/* Dark Theme */
[data-theme="dark"] .ai-chat-window {
    background: var(--dark-bg-secondary, #2d3748);
    border-color: var(--dark-border-color, #4a5568);
}

[data-theme="dark"] .ai-quick-actions {
    background: var(--dark-bg-tertiary, #374151);
    border-bottom-color: var(--dark-border-color, #4a5568);
}

[data-theme="dark"] .quick-action-btn {
    background: var(--dark-bg-secondary, #2d3748);
    border-color: var(--dark-border-color, #4a5568);
    color: var(--dark-text-primary, #e2e8f0);
}

[data-theme="dark"] .ai-message-text {
    background: var(--dark-bg-tertiary, #374151);
    color: var(--dark-text-primary, #e2e8f0);
}

[data-theme="dark"] .ai-message-avatar {
    background: var(--dark-bg-tertiary, #374151);
}

[data-theme="dark"] .ai-chat-input {
    background: var(--dark-bg-tertiary, #374151);
    border-color: var(--dark-border-color, #4a5568);
    color: var(--dark-text-primary, #e2e8f0);
}

[data-theme="dark"] .ai-chat-input-container {
    border-top-color: var(--dark-border-color, #4a5568);
}

/* Mobile Responsiveness */
@media (max-width: 768px) {
    .ai-chat-window {
        width: calc(100vw - 20px);
        max-width: 390px;
        right: 10px;
        bottom: 10px;
    }
    
    .ai-assistant-toggle {
        width: 50px;
        height: 50px;
        font-size: 20px;
        bottom: 15px;
        right: 15px;
    }
    
    .quick-action-buttons {
        justify-content: flex-start;
    }
    
    .quick-action-btn {
        font-size: 10px;
        padding: 4px 8px;
    }
}
</style>

<!-- Enhanced AI Assistant JavaScript -->
<script>
/**
 * Enhanced AI Assistant with GPT-4 Integration
 * Supports customer service, command execution, and shared memory
 */
class EnhancedAIAssistant {
    constructor(app) {
        this.app = app;
        this.isOpen = false;
        this.conversation = [];
        this.userContext = {};
        this.isTyping = false;
        this.apiKey = localStorage.getItem('openai_api_key') || '';
        this.isMinimized = false;
        this.isLargeSize = false;
        this.isDragging = false;
        this.dragOffset = { x: 0, y: 0 };
        this.currentPosition = this.getStoredPosition();
        
        // Initialize user context
        this.initializeUserContext();
        
        // Bind methods (only bind existing methods)
        this.toggle = this.toggle.bind(this);
        this.sendMessage = this.sendMessage.bind(this);
        this.handleInput = this.handleInput.bind(this);
        this.handleQuickAction = this.handleQuickAction.bind(this);
        this.startDrag = this.startDrag.bind(this);
        this.drag = this.drag.bind(this);
        this.stopDrag = this.stopDrag.bind(this);
        
        this.init();
    }
    
    init() {
        console.log('ü§ñ Initializing Enhanced AI Assistant...');
        try {
            this.setupEventListeners();
            this.loadConversationHistory();
            this.updateUserContext();
            this.setupDragAndResize();
            this.restorePosition();
            console.log('‚úÖ AI Assistant initialized successfully');
        } catch (error) {
            console.error('‚ùå AI Assistant initialization error:', error);
            // Continue with minimal functionality
            this.setupBasicEventListeners();
        }
    }
    
    /**
     * Setup basic event listeners as fallback
     */
    setupBasicEventListeners() {
        const toggleBtn = document.getElementById('ai-assistant-toggle');
        const chatWindow = document.getElementById('ai-chat-window');
        
        if (toggleBtn && chatWindow) {
            toggleBtn.addEventListener('click', () => {
                const isVisible = chatWindow.style.display === 'flex';
                chatWindow.style.display = isVisible ? 'none' : 'flex';
                console.log('ü§ñ AI Assistant toggled (basic mode)');
            });
        }
    }
    
    getStoredPosition() {
        const stored = localStorage.getItem('ai-assistant-position');
        if (stored) {
            return JSON.parse(stored);
        }
        return {
            bottom: '20px',
            right: '20px',
            width: '420px',
            height: '600px'
        };
    }
    
    savePosition() {
        localStorage.setItem('ai-assistant-position', JSON.stringify(this.currentPosition));
    }
    
    restorePosition() {
        const chatWindow = document.getElementById('ai-chat-window');
        if (chatWindow) {
            chatWindow.style.bottom = this.currentPosition.bottom;
            chatWindow.style.right = this.currentPosition.right;
            chatWindow.style.width = this.currentPosition.width;
            chatWindow.style.height = this.currentPosition.height;
            // Ensure left is not set
            chatWindow.style.left = 'auto';
        }
    }
    
    setupDragAndResize() {
        const dragHandle = document.getElementById('ai-drag-handle');
        const resizeToggle = document.getElementById('ai-resize-toggle');
        
        if (dragHandle) {
            dragHandle.addEventListener('mousedown', this.startDrag);
        }
        
        if (resizeToggle) {
            resizeToggle.addEventListener('click', () => this.toggleSize());
        }
        
        // Global mouse events for dragging
        document.addEventListener('mousemove', this.drag);
        document.addEventListener('mouseup', this.stopDrag);
    }
    
    startDrag(e) {
        e.preventDefault();
        this.isDragging = true;
        const chatWindow = document.getElementById('ai-chat-window');
        const rect = chatWindow.getBoundingClientRect();
        
        this.dragOffset.x = e.clientX - rect.left;
        this.dragOffset.y = e.clientY - rect.top;
        
        chatWindow.style.cursor = 'grabbing';
        document.body.style.userSelect = 'none';
    }
    
    drag(e) {
        if (!this.isDragging) return;
        
        e.preventDefault();
        const chatWindow = document.getElementById('ai-chat-window');
        
        const newX = window.innerWidth - (e.clientX - this.dragOffset.x + chatWindow.offsetWidth);
        const newY = window.innerHeight - (e.clientY - this.dragOffset.y + chatWindow.offsetHeight);
        
        // Keep within bounds
        const maxX = window.innerWidth - 300; // Minimum 300px visible
        const maxY = window.innerHeight - 100; // Minimum 100px visible
        
        const boundedX = Math.max(20, Math.min(newX, maxX));
        const boundedY = Math.max(20, Math.min(newY, maxY));
        
        chatWindow.style.right = boundedX + 'px';
        chatWindow.style.bottom = boundedY + 'px';
        
        this.currentPosition.right = boundedX + 'px';
        this.currentPosition.bottom = boundedY + 'px';
    }
    
    stopDrag() {
        if (!this.isDragging) return;
        
        this.isDragging = false;
        const chatWindow = document.getElementById('ai-chat-window');
        chatWindow.style.cursor = 'default';
        document.body.style.userSelect = '';
        
        this.savePosition();
    }
    
    toggleSize() {
        const chatWindow = document.getElementById('ai-chat-window');
        const resizeIcon = document.querySelector('#ai-resize-toggle i');
        
        if (this.isLargeSize) {
            // Switch to normal size
            chatWindow.style.width = '380px';
            chatWindow.style.height = '500px';
            resizeIcon.className = 'fas fa-expand-arrows-alt';
            this.isLargeSize = false;
        } else {
            // Switch to large size
            chatWindow.style.width = '500px';
            chatWindow.style.height = '650px';
            resizeIcon.className = 'fas fa-compress-arrows-alt';
            this.isLargeSize = true;
        }
        
        this.currentPosition.width = chatWindow.style.width;
        this.currentPosition.height = chatWindow.style.height;
        this.savePosition();
    }
    
    initializeUserContext() {
        this.userContext = {
            timestamp: new Date().toISOString(),
            systemInfo: {
                platform: 'Enhanced Media Scraper',
                version: '2.0.5',
                features: ['search', 'download', 'asset_management', 'customer_service'],
                userAgent: navigator.userAgent,
                theme: document.documentElement.getAttribute('data-theme') || 'light'
            },
            userPreferences: {
                safeSearch: localStorage.getItem('safe_search') || 'true',
                maxItems: localStorage.getItem('default_max_items') || '25',
                theme: localStorage.getItem('theme') || 'light'
            },
            capabilities: [
                'Search and download media from 78+ sources',
                'Asset management and organization', 
                'Customer service and support',
                'Command execution (delete assets, start searches, etc.)',
                'Account and subscription management',
                'Troubleshooting and help'
            ]
        };
    }
    
    setupEventListeners() {
        // Toggle button
        const toggleBtn = document.getElementById('ai-assistant-toggle');
        if (toggleBtn) {
            toggleBtn.addEventListener('click', this.toggle);
        }
        
        // Close/minimize buttons
        const closeBtn = document.getElementById('ai-close');
        const minimizeBtn = document.getElementById('ai-minimize');
        
        if (closeBtn) {
            closeBtn.addEventListener('click', () => this.close());
        }
        
        if (minimizeBtn) {
            minimizeBtn.addEventListener('click', () => this.minimize());
        }
        
        // Clear conversation
        const clearBtn = document.getElementById('ai-clear-conversation');
        if (clearBtn) {
            clearBtn.addEventListener('click', () => this.clearConversation());
        }
        
        // Chat input
        const chatInput = document.getElementById('ai-chat-input');
        const sendBtn = document.getElementById('ai-send-btn');
        const charCount = document.getElementById('ai-char-count');
        
        if (chatInput) {
            chatInput.addEventListener('input', this.handleInput);
            chatInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    this.sendMessage();
                }
            });
            
            // Auto-resize textarea
            chatInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 100) + 'px';
            });
        }
        
        if (sendBtn) {
            sendBtn.addEventListener('click', this.sendMessage);
        }
        
        // Quick action buttons
        const quickActionBtns = document.querySelectorAll('.quick-action-btn');
        quickActionBtns.forEach(btn => {
            btn.addEventListener('click', this.handleQuickAction);
        });
    }
    
    toggle() {
        if (this.isOpen) {
            this.close();
        } else {
            this.open();
        }
    }
    
    open() {
        const chatWindow = document.getElementById('ai-chat-window');
        const toggleButton = document.getElementById('ai-assistant-toggle');
        
        if (chatWindow && !this.isOpen) {
            // Animate toggle button expanding
            if (toggleButton) {
                toggleButton.classList.add('expanding');
                setTimeout(() => {
                    toggleButton.classList.remove('expanding');
                }, 400);
            }
            
            // Show chat window with animation
            chatWindow.style.display = 'flex';
            chatWindow.classList.add('appearing');
            
            // Remove animation class after animation completes
            setTimeout(() => {
                chatWindow.classList.remove('appearing');
            }, 400);
            
            this.isOpen = true;
            
            // Focus input after animation
            const chatInput = document.getElementById('ai-chat-input');
            if (chatInput) {
                setTimeout(() => chatInput.focus(), 450);
            }
            
            // Auto-scroll to bottom
            this.scrollToBottom();
            
            this.updateStatus('Ready to help');
            console.log('ü§ñ AI Assistant opened with animation');
        }
    }
    
    close() {
        const chatWindow = document.getElementById('ai-chat-window');
        const toggleButton = document.getElementById('ai-assistant-toggle');
        
        if (chatWindow && this.isOpen) {
            // Animate chat window disappearing
            chatWindow.classList.add('disappearing');
            
            // Animate toggle button collapsing back
            if (toggleButton) {
                setTimeout(() => {
                    toggleButton.classList.add('collapsing');
                    setTimeout(() => {
                        toggleButton.classList.remove('collapsing');
                    }, 400);
                }, 200);
            }
            
            // Hide after animation
            setTimeout(() => {
                chatWindow.style.display = 'none';
                chatWindow.classList.remove('disappearing');
            }, 400);
            
            this.isOpen = false;
            console.log('ü§ñ AI Assistant closed with animation');
        }
    }
    
    scrollToBottom() {
        const messagesContainer = document.getElementById('ai-chat-messages');
        if (messagesContainer) {
            // Smooth scroll to bottom
            messagesContainer.scrollTo({
                top: messagesContainer.scrollHeight,
                behavior: 'smooth'
            });
        }
    }
    
    handleInput(event) {
        const input = event.target;
        const charCount = document.getElementById('ai-char-count');
        const sendBtn = document.getElementById('ai-send-btn');
        
        if (charCount) {
            charCount.textContent = input.value.length;
        }
        
        if (sendBtn) {
            sendBtn.disabled = input.value.trim().length === 0;
        }
    }
    
    async handleQuickAction(event) {
        const action = event.currentTarget.dataset.action;
        let message = '';
        
        switch (action) {
            case 'search':
                message = "I'd like to start a new search. Can you help me set up a search?";
                break;
            case 'view-assets':
                message = "Show me my downloaded assets and recent files.";
                break;
            case 'account-info':
                message = "Tell me about my account, subscription, and usage statistics.";
                break;
            case 'help':
                message = "I need help understanding how to use the Enhanced Media Scraper.";
                break;
        }
        
        if (message) {
            const chatInput = document.getElementById('ai-chat-input');
            if (chatInput) {
                chatInput.value = message;
                this.handleInput({ target: chatInput });
                await this.sendMessage();
            }
        }
    }
    
    async sendMessage() {
        const chatInput = document.getElementById('ai-chat-input');
        if (!chatInput || !chatInput.value.trim()) return;
        
        const userMessage = chatInput.value.trim();
        chatInput.value = '';
        this.handleInput({ target: chatInput });
        
        // Add user message to conversation
        this.addMessage('user', userMessage);
        
        // Check for commands
        const commandResponse = await this.processCommand(userMessage);
        if (commandResponse) {
            this.addMessage('assistant', commandResponse);
            return;
        }
        
        // Show typing indicator
        this.showTyping();
        
        try {
            // Use the enhanced AI assistant API
            const response = await this.callEnhancedAI(userMessage);
            this.hideTyping();
            this.addMessage('assistant', response);
            this.scrollToBottom();
            
        } catch (error) {
            this.hideTyping();
            console.error('AI Assistant error:', error);
            this.addMessage('assistant', 
                '‚ùå I apologize, but I encountered an error processing your request. Please try again or contact support if the issue persists.'
            );
            this.scrollToBottom();
        }
    }
    
    async processCommand(message) {
        const lowerMessage = message.toLowerCase();
        
        // Delete commands
        if (lowerMessage.includes('delete all') && (lowerMessage.includes('image') || lowerMessage.includes('asset'))) {
            return await this.executeDeleteAllCommand('images');
        }
        
        if (lowerMessage.includes('delete all') && lowerMessage.includes('video')) {
            return await this.executeDeleteAllCommand('videos');
        }
        
        if (lowerMessage.includes('delete all') && (lowerMessage.includes('file') || lowerMessage.includes('everything'))) {
            return await this.executeDeleteAllCommand('all');
        }
        
        // Search commands
        if (lowerMessage.includes('start search') || lowerMessage.includes('search for')) {
            return this.executeSearchCommand(message);
        }
        
        // Navigation commands
        if (lowerMessage.includes('show assets') || lowerMessage.includes('view assets')) {
            return this.executeNavigationCommand('assets');
        }
        
        if (lowerMessage.includes('show dashboard') || lowerMessage.includes('go to dashboard')) {
            return this.executeNavigationCommand('dashboard');
        }
        
        return null;
    }
    
    async executeDeleteAllCommand(type) {
        const typeText = type === 'all' ? 'all assets' : type;
        
        if (confirm(`‚ö†Ô∏è Are you sure you want to delete ${typeText}? This action cannot be undone.`)) {
            try {
                if (this.app.modules?.assetManager?.deleteAll) {
                    await this.app.modules.assetManager.deleteAll();
                    return `‚úÖ Successfully deleted all ${typeText}. Your asset library has been cleared.`;
                } else {
                    return `‚ùå Unable to delete ${typeText}. The delete function is not available right now.`;
                }
            } catch (error) {
                return `‚ùå Failed to delete ${typeText}: ${error.message}`;
            }
        } else {
            return `Operation cancelled. Your ${typeText} are safe.`;
        }
    }
    
    executeSearchCommand(message) {
        if (this.app.showSection) {
            this.app.showSection('search');
            return `üîç I've opened the Search & Download section for you. You can now configure your search parameters and select sources to search from.`;
        }
        return `üîç To start a search, please navigate to the Search & Download section using the sidebar.`;
    }
    
    executeNavigationCommand(section) {
        if (this.app.showSection) {
            this.app.showSection(section);
            return `‚úÖ I've navigated you to the ${section.charAt(0).toUpperCase() + section.slice(1)} section.`;
        }
        return `Please use the sidebar navigation to access the ${section} section.`;
    }
    
    async getAIResponse(userMessage) {
        // For demo purposes, return contextual responses
        // In production, this would call the OpenAI API
        
        const context = this.buildContextPrompt();
        const lowerMessage = userMessage.toLowerCase();
        
        // Customer service responses based on keywords
        if (lowerMessage.includes('subscription') || lowerMessage.includes('plan') || lowerMessage.includes('upgrade')) {
            return this.getSubscriptionInfo();
        }
        
        if (lowerMessage.includes('credit') || lowerMessage.includes('usage')) {
            return this.getCreditInfo();
        }
        
        if (lowerMessage.includes('help') || lowerMessage.includes('how to') || lowerMessage.includes('tutorial')) {
            return this.getHelpInfo();
        }
        
        if (lowerMessage.includes('account') || lowerMessage.includes('profile')) {
            return this.getAccountInfo();
        }
        
        if (lowerMessage.includes('sources') || lowerMessage.includes('sites') || lowerMessage.includes('platform')) {
            return this.getSourceInfo();
        }
        
        // Default AI response (would be GPT-4 API call in production)
        return `I understand you're asking about: "${userMessage}"

As your AI assistant for Enhanced Media Scraper, I can help you with:

üîç **Search & Download**: Configure searches across 78+ content sources
üìÇ **Asset Management**: Organize, view, and manage your downloaded content  
‚öôÔ∏è **Account Settings**: Check subscription status, credits, and preferences
‚ùì **Support**: Get help with features, troubleshooting, and best practices

Could you please be more specific about what you'd like help with? For example:
- "How do I search for images on Instagram?"
- "What's my current subscription status?"
- "Delete all my downloaded videos"
- "Show me how to use safe search"`;
    }
    
    getSubscriptionInfo() {
        return `üí≥ **Subscription Information**

**Current Plan**: Free Tier
**Status**: Active
**Credits Remaining**: Check your dashboard for real-time credit count

**Available Plans**:
- üÜì **Free**: Limited searches, basic features
- ‚≠ê **Premium**: Unlimited searches, priority support, advanced features
- üöÄ **Ultra**: Everything + API access, bulk operations, white-label

**Features Included**:
- Access to 78+ content sources
- High-quality downloads
- Asset management
- AI assistant support

To upgrade your plan, please contact our support team or visit the subscription section in your account settings.`;
    }
    
    getCreditInfo() {
        const creditsElement = document.getElementById('credits-count');
        const currentCredits = creditsElement ? creditsElement.textContent : 'N/A';
        
        return `üí∞ **Credit Information**

**Current Credits**: ${currentCredits}
**Usage**: Credits are consumed per search operation
**Refill**: Credits refill monthly based on your subscription plan

**Credit Usage**:
- Basic search: 1 credit
- Comprehensive search: 2-5 credits (depending on sources)
- Premium sources: Additional credits may apply

**Tips to Save Credits**:
- Use targeted searches instead of comprehensive
- Enable safe search to filter results
- Set appropriate max item limits

Need more credits? Consider upgrading your subscription plan for higher monthly allowances.`;
    }
    
    getHelpInfo() {
        return `üìö **How to Use Enhanced Media Scraper**

**Quick Start Guide**:
1. **Search**: Use the Search & Download section to configure your search
2. **Sources**: Select which platforms to search (Instagram, Reddit, etc.)
3. **Download**: Set max items and start your search
4. **Manage**: View and organize downloads in the Assets Library

**Key Features**:
- üîç **Smart Search**: AI-powered search optimization
- üìÇ **Asset Management**: Organize downloads with metadata
- üõ°Ô∏è **Safe Search**: Filter adult content automatically
- üéØ **Targeted Search**: Search specific platforms or comprehensive

**Pro Tips**:
- Use specific keywords for better results
- Enable safe search for family-friendly content
- Set reasonable max item limits to save credits
- Regularly clean up old downloads to save space

**Need More Help?**: Try specific questions like "How do I search Instagram?" or "What are the different search types?"`;
    }
    
    getAccountInfo() {
        const theme = document.documentElement.getAttribute('data-theme') || 'light';
        const safeSearch = document.getElementById('safe-search-toggle')?.checked || false;
        
        return `üë§ **Account Information**

**Profile Settings**:
- Theme: ${theme.charAt(0).toUpperCase() + theme.slice(1)} mode
- Safe Search: ${safeSearch ? 'Enabled' : 'Disabled'}
- Account Type: Standard User

**System Preferences**:
- Default max items: ${this.userContext.userPreferences.maxItems}
- Content filtering: ${safeSearch ? 'Family-friendly' : 'All content'}
- Auto-cleanup: Enabled

**Usage Statistics**:
- Total searches: Available in dashboard
- Total downloads: Check your Assets Library
- Storage used: View in system status

**Privacy & Security**:
- Data encryption: All downloads are secure
- Privacy mode: Your searches are private
- Data retention: According to privacy policy

To modify any of these settings, visit the Settings section or use voice commands like "enable safe search" or "switch to dark theme".`;
    }
    
    getSourceInfo() {
        return `üåê **Available Content Sources**

**Social Media** (18 sources):
- Instagram, Twitter, TikTok, Facebook
- Reddit, Tumblr, Pinterest, LinkedIn

**Video Platforms** (12 sources):
- YouTube, Vimeo, Dailymotion, Twitch
- Custom video hosting platforms

**Image Galleries** (15 sources):
- Flickr, 500px, DeviantArt, Behance
- Stock photo sites, Art galleries

**Search Engines** (8 sources):
- Google Images, Bing, DuckDuckGo
- Specialized content search engines

**Direct Sources** (20+ sources):
- News sites, Blogs, Forums
- Custom content platforms

**Adult Content** (5+ sources):
- Available with subscription upgrade
- Age verification required
- Enhanced privacy features

**Source Status**: All sources are regularly updated and maintained for optimal performance.

Want to search specific sources? Try commands like "search Instagram for cats" or "find videos on YouTube about cooking".`;
    }
    
    /**
     * Call the enhanced AI API for responses
     * @param {string} userMessage - User's message
     * @returns {Promise<string>} - AI response
     */
    async callEnhancedAI(userMessage) {
        try {
            // Try to use the backend AI assistant API first
            const response = await fetch('/api/ai-assistant', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    message: userMessage,
                    context: this.userContext
                })
            });
            
            if (response.ok) {
                const data = await response.json();
                return data.response || data.message || 'I received your message but had trouble generating a response.';
            } else {
                // Fallback to local AI response
                console.warn('AI API not available, using local responses');
                return await this.getAIResponse(userMessage);
            }
        } catch (error) {
            console.warn('AI API error, using local responses:', error);
            // Fallback to local AI response
            return await this.getAIResponse(userMessage);
        }
    }
    
    buildContextPrompt() {
        return `You are an AI assistant for Enhanced Media Scraper, a professional media downloading platform. 

Current user context:
- Platform: ${this.userContext.systemInfo.platform}
- Theme: ${this.userContext.userPreferences.theme}
- Safe Search: ${this.userContext.userPreferences.safeSearch}

You can help with:
1. Customer service and account management
2. Search and download operations
3. Asset management and organization
4. Technical support and troubleshooting
5. Command execution (delete files, start searches, navigate sections)

Always be helpful, professional, and provide actionable solutions.`;
    }
    
    addMessage(role, content) {
        const messagesContainer = document.getElementById('ai-chat-messages');
        if (!messagesContainer) return;
        
        const messageElement = document.createElement('div');
        messageElement.className = role === 'user' ? 'user-message' : 'ai-message';
        
        const timestamp = new Date().toLocaleTimeString();
        
        messageElement.innerHTML = `
            <div class="ai-message">
                <div class="ai-message-avatar">
                    <i class="fas fa-${role === 'user' ? 'user' : 'robot'}"></i>
                </div>
                <div class="ai-message-content">
                    <div class="ai-message-text">${this.formatMessage(content)}</div>
                    <div class="ai-message-time">${timestamp}</div>
                </div>
            </div>
        `;
        
        // Remove welcome message if it exists
        const welcomeMessage = messagesContainer.querySelector('.ai-welcome-message');
        if (welcomeMessage && role === 'user') {
            welcomeMessage.remove();
        }
        
        messagesContainer.appendChild(messageElement);
        
        // Auto-scroll to bottom with smooth animation
        this.scrollToBottom();
        
        // Store in conversation history
        this.conversation.push({ role, content, timestamp });
        this.saveConversationHistory();
    }
    
    scrollToBottom() {
        const messagesContainer = document.getElementById('ai-chat-messages');
        if (messagesContainer) {
            setTimeout(() => {
                messagesContainer.scrollTo({
                    top: messagesContainer.scrollHeight,
                    behavior: 'smooth'
                });
            }, 100);
        }
    }
    
    formatMessage(content) {
        // Convert markdown-like formatting to HTML
        return content
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*(.*?)\*/g, '<em>$1</em>')
            .replace(/\n/g, '<br>');
    }
    
    showTyping() {
        const typingIndicator = document.getElementById('ai-typing-indicator');
        if (typingIndicator) {
            typingIndicator.style.display = 'block';
            
            // Auto-scroll to show typing indicator
            this.scrollToBottom();
        }
        this.updateStatus('Thinking...');
        this.isTyping = true;
    }
    
    hideTyping() {
        const typingIndicator = document.getElementById('ai-typing-indicator');
        if (typingIndicator) {
            typingIndicator.style.display = 'none';
        }
        this.updateStatus('Ready to help');
        this.isTyping = false;
    }
    
    updateStatus(status) {
        const statusElement = document.getElementById('ai-status');
        if (statusElement) {
            statusElement.textContent = status;
        }
    }
    
    clearConversation() {
        if (confirm('Are you sure you want to clear the conversation? This action cannot be undone.')) {
            const messagesContainer = document.getElementById('ai-chat-messages');
            if (messagesContainer) {
                messagesContainer.innerHTML = `
                    <div class="ai-welcome-message">
                        <div class="ai-message">
                            <div class="ai-message-avatar">
                                <i class="fas fa-robot"></i>
                            </div>
                            <div class="ai-message-content">
                                <div class="ai-message-text">
                                    üîÑ <strong>Conversation cleared!</strong><br><br>
                                    I'm ready to help you with Enhanced Media Scraper. What would you like to do?
                                </div>
                                <div class="ai-message-time">Just now</div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            this.conversation = [];
            this.saveConversationHistory();
            console.log('ü§ñ Conversation cleared');
        }
    }
    
    updateUserContext() {
        // Update context with current app state
        if (this.app) {
            this.userContext.appState = {
                currentSection: this.app.currentSection || 'dashboard',
                assetsCount: document.getElementById('total-assets-badge')?.textContent || '0',
                credits: document.getElementById('credits-count')?.textContent || '0'
            };
        }
    }
    
    saveConversationHistory() {
        try {
            localStorage.setItem('ai_conversation_history', JSON.stringify(this.conversation.slice(-20))); // Keep last 20 messages
        } catch (error) {
            console.warn('Failed to save conversation history:', error);
        }
    }
    
    loadConversationHistory() {
        try {
            const saved = localStorage.getItem('ai_conversation_history');
            if (saved) {
                this.conversation = JSON.parse(saved);
            }
        } catch (error) {
            console.warn('Failed to load conversation history:', error);
            this.conversation = [];
        }
    }
}

// Initialize Enhanced AI Assistant when DOM is ready and main app is available
function initializeAIAssistant() {
    console.log('ü§ñ AI Assistant initialization attempt...');
    
    // Check if main app is available
    if (window.app || window.mediaScraperApp) {
        try {
            const appInstance = window.app || window.mediaScraperApp;
            window.enhancedAIAssistant = new EnhancedAIAssistant(appInstance);
            console.log('ü§ñ Enhanced AI Assistant initialized successfully with main app');
            return true;
        } catch (error) {
            console.error('ü§ñ Failed to initialize AI Assistant with main app:', error);
        }
    }
    
    // Initialize without main app as fallback
    try {
        window.enhancedAIAssistant = new EnhancedAIAssistant({});
        console.log('ü§ñ Enhanced AI Assistant initialized successfully (standalone mode)');
        return true;
    } catch (error) {
        console.error('ü§ñ Failed to initialize AI Assistant (standalone mode):', error);
        
        // Final fallback: Simple click handler for the toggle button
        const toggleBtn = document.getElementById('ai-assistant-toggle');
        if (toggleBtn) {
            toggleBtn.addEventListener('click', function() {
                console.log('ü§ñ AI Assistant button clicked (fallback mode)');
                const chatWindow = document.getElementById('ai-chat-window');
                if (chatWindow) {
                    const isVisible = chatWindow.style.display === 'flex';
                    chatWindow.style.display = isVisible ? 'none' : 'flex';
                    
                    if (!isVisible) {
                        // Focus input when opening
                        const chatInput = document.getElementById('ai-chat-input');
                        if (chatInput) {
                            setTimeout(() => chatInput.focus(), 100);
                        }
                    }
                }
            });
            console.log('ü§ñ Fallback click handler attached');
        }
        return false;
    }
}

// Initialize immediately when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    console.log('ü§ñ AI Assistant DOM ready...');
    
    // Try to initialize immediately
    if (initializeAIAssistant()) {
        return;
    }
    
    // If that fails, wait for main app with polling
    let attempts = 0;
    const maxAttempts = 20; // 10 seconds total
    
    const waitForMainApp = setInterval(() => {
        attempts++;
        console.log(`ü§ñ AI Assistant waiting for main app (attempt ${attempts}/${maxAttempts})`);
        
        if (initializeAIAssistant() || attempts >= maxAttempts) {
            clearInterval(waitForMainApp);
            if (attempts >= maxAttempts) {
                console.warn('ü§ñ AI Assistant initialization timeout - running in fallback mode');
            }
        }
    }, 500);
});
</script> 