<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Media Scraper - Unified Platform</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --bg-gradient-start: #667eea;
            --bg-gradient-end: #764ba2;
            --text-primary: #2d3748;
            --text-secondary: #4a5568;
            --text-muted: #718096;
            --bg-primary: #f8f9fa;
            --bg-secondary: #ffffff;
            --bg-card: rgba(255, 255, 255, 0.95);
            --border-color: #e2e8f0;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --navbar-bg: rgba(102, 126, 234, 0.95);
            --command-center-bg: rgba(255, 255, 255, 0.98);
            --overlay-bg: rgba(0, 0, 0, 0.5);
        }
        
        /* Dark theme */
        [data-theme="dark"] {
            --primary-color: #9f7aea;
            --secondary-color: #667eea;
            --bg-gradient-start: #1a202c;
            --bg-gradient-end: #2d3748;
            --text-primary: #e2e8f0;
            --text-secondary: #cbd5e0;
            --text-muted: #a0aec0;
            --bg-primary: #1a202c;
            --bg-secondary: #2d3748;
            --bg-card: rgba(45, 55, 72, 0.95);
            --border-color: #4a5568;
            --shadow-color: rgba(0, 0, 0, 0.3);
            --navbar-bg: rgba(45, 55, 72, 0.95);
            --command-center-bg: rgba(26, 32, 44, 0.98);
            --overlay-bg: rgba(0, 0, 0, 0.7);
        }
        
        body {
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            background-attachment: fixed;
            min-height: 100vh;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            color: var(--text-primary);
        }
        
        /* Subscription Status Styles */
        .subscription-status {
            background: rgba(255, 243, 205, 0.9);
            border: 2px solid #ffc107;
            color: #856404;
            padding: 8px 20px;
            border-radius: 25px;
            font-weight: 600;
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }
        
        .subscription-status.premium {
            background: rgba(40, 167, 69, 0.1);
            border-color: #28a745;
            color: #155724;
        }
        
        .subscription-status.ultra {
            background: rgba(111, 66, 193, 0.1);
            border-color: #6f42c1;
            color: #4a148c;
        }
        
        /* Enhanced Credits Display */
        .credits-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 6px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
            margin-right: 10px;
        }
        
        .credits-display i {
            font-size: 1rem;
        }
        
        .credits-count {
            font-size: 1.1rem;
            font-weight: 700;
        }
        
        /* Enhanced Sources Table Layout */
        .sources-table-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        .sources-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }
        
        .sources-table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .sources-table th {
            padding: 16px 20px;
            text-align: left;
            font-weight: 600;
            font-size: 0.95rem;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }
        
        .sources-table td {
            padding: 14px 20px;
            border-bottom: 1px solid #f0f0f0;
            vertical-align: middle;
        }
        
        .sources-table tbody tr:hover {
            background-color: #f8f9fa;
            transition: background-color 0.2s ease;
        }
        
        .sources-table tbody tr:last-child td {
            border-bottom: none;
        }
        
        /* Fixed widths for consistent alignment */
        .sources-table .checkbox-col {
            width: 60px;
            text-align: center;
        }
        
        .sources-table .icon-col {
            width: 60px;
            text-align: center;
        }
        
        .sources-table .name-col {
            width: 35%;
            font-weight: 600;
            color: #2d3748;
        }
        
        .sources-table .category-col {
            width: 25%;
            color: #718096;
        }
        
        .sources-table .status-col {
            width: 20%;
            text-align: center;
        }
        
        /* Source status indicators */
        .source-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        .source-status.enabled {
            background: #d4edda;
            color: #155724;
        }
        
        .source-status.locked {
            background: #f8d7da;
            color: #721c24;
        }
        
        /* Category badge styles */
        .category-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 0.85rem;
            background: #f0f0f0;
            color: #4a5568;
        }
        
        /* Source icon styles */
        .source-icon {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            font-size: 1.2rem;
        }
        
        .source-icon.social { background: rgba(59, 89, 152, 0.1); color: #3b5998; }
        .source-icon.video { background: rgba(255, 0, 0, 0.1); color: #ff0000; }
        .source-icon.search { background: rgba(66, 133, 244, 0.1); color: #4285f4; }
        .source-icon.art { background: rgba(233, 30, 99, 0.1); color: #e91e63; }
        .source-icon.gallery { background: rgba(255, 152, 0, 0.1); color: #ff9800; }
        .source-icon.stock { background: rgba(0, 188, 212, 0.1); color: #00bcd4; }
        .source-icon.news { background: rgba(96, 125, 139, 0.1); color: #607d8b; }
        .source-icon.direct { background: rgba(121, 85, 72, 0.1); color: #795548; }
        .source-icon.adult { background: rgba(244, 67, 54, 0.1); color: #f44336; }
        
        /* Source checkbox styling */
        .source-table-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #667eea;
        }
        
        .source-table-checkbox:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }
        
        /* Category section header */
        .category-section-header {
            background: #f8f9fa;
            padding: 12px 20px;
            font-weight: 600;
            color: #4a5568;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .category-section-header .category-controls {
            display: flex;
            gap: 8px;
        }
        
        .category-controls button {
            padding: 4px 12px;
            font-size: 0.8rem;
            border-radius: 6px;
        }
        
        .subscription-badge {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        /* Source Lock Styles */
        .source-item.locked {
            opacity: 0.6;
            position: relative;
        }
        
        .source-item.locked::after {
            content: '\f023';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
        }
        
        .source-item.locked:hover::before {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.8rem;
            white-space: nowrap;
            z-index: 10;
        }
        
        /* Load watermark CSS */
        @import url('/api/watermark-css');
        
        .main-container {
            display: flex;
            min-height: 100vh;
        }
        
        .sidebar {
            width: 280px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 20px;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            color: #1a202c;
        }
        
        .content-area {
            flex: 1;
            padding: 20px;
            overflow-x: hidden;
        }
        
        /* User Avatar/Initials Badge Styles - Clean and Standard */
        .user-avatar-badge {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #667eea;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 16px;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .user-avatar-badge:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
            border-color: rgba(255, 255, 255, 0.4);
        }
        
        /* Remove old complex styling */
        .user-dropdown-toggle {
            background: none !important;
            border: none !important;
            padding: 0 !important;
            outline: none !important;
        }
        
        .user-dropdown-toggle:hover {
            transform: none !important;
        }
        
        .user-dropdown-toggle:focus {
            box-shadow: none !important;
            outline: none !important;
        }
        
        .nav-item {
            margin-bottom: 5px;
            padding: 12px 15px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #4a5568;
        }
        
        .nav-item:hover {
            background: rgba(102, 126, 234, 0.1);
        }
        
        .nav-item.active {
            background: var(--primary-color);
            color: white;
        }
        
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 6px var(--shadow-color);
            border-radius: 15px;
            margin-bottom: 20px;
            color: #1a202c;
        }
        
        .card-header {
            background: transparent;
            border-bottom: 1px solid rgba(0,0,0,0.1);
            border-radius: 15px 15px 0 0 !important;
            padding: 20px;
            color: #1a202c;
        }
        
        .status-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 350px;
            max-height: 500px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }
        
        .progress-item {
            background: rgba(255,255,255,0.95);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .asset-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 20px;
            padding: 20px 0;
            width: 100%;
        }
        
        /* ENHANCED: Assets grid container for proper tiled layout - 5 per row */
        .assets-grid-container {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 20px;
            padding: 20px 0;
            width: 100%;
        }

        /* Responsive grid adjustments for different screen sizes */
        @media (max-width: 1400px) {
            .asset-grid, .assets-grid-container {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        @media (max-width: 1000px) {
            .asset-grid, .assets-grid-container {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 768px) {
            .asset-grid, .assets-grid-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 480px) {
            .asset-grid, .assets-grid-container {
                grid-template-columns: 1fr;
            }
        }
        
        /* ENHANCED: Section titles for organized display */
        .section-title {
            margin: 20px 0 15px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary-color);
            color: #1a202c;
            font-weight: 700;
            margin-bottom: 20px;
        }
        
        .section-title h4 {
            margin: 0;
            color: white;  /* White text on gradient background */
            font-weight: 600;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }
        
        .asset-card {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
            margin: 0;
            padding: 0;
            /* CRITICAL: Ensure consistent height for all cards */
            display: flex;
            flex-direction: column;
            height: auto;
            min-height: 0;
        }
        
        .asset-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }

        /* ENHANCED: Asset image styling */
        .asset-image {
            width: 100%;
            height: 150px;
            object-fit: cover;
            display: block;
        }
        
        /* ENHANCED: Asset preview container */
        .asset-preview {
            width: 100%;
            height: 150px;
            background: var(--light-color);
            display: block;
            margin: 0;
            padding: 0;
            border: none;
            line-height: 0;
            font-size: 0;
            vertical-align: top;
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
        }
        
        /* CONSISTENT: Image and video preview containers */
        .video-thumbnail {
            width: 100%;
            height: 150px;
            background: var(--light-color);
            display: block;
            margin: 0;
            padding: 0;
            border: none;
            line-height: 0;
            font-size: 0;
            vertical-align: top;
            position: relative;
            overflow: hidden;
            /* CRITICAL: Prevent any flex growth */
            flex-shrink: 0;
        }
        
        /* CONSISTENT: Info section for both image and video cards */
        .asset-info {
            padding: 15px;
            margin: 0;
            line-height: normal;
            font-size: inherit;
            /* CRITICAL: Allow info to fill remaining space consistently */
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 60px; /* Ensure minimum height for consistency */
            background: rgba(255, 255, 255, 0.95);
            color: #2d3748;
        }
        
        .asset-info h4 {
            color: #1a202c;
            margin-bottom: 10px;
        }
        
        .asset-info p {
            color: #4a5568;
            margin: 5px 0;
        }
        
        .asset-filename {
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 0.85em;  /* Slightly smaller */
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            color: #1a202c;  /* Almost black for readability */
            flex-shrink: 0;
        }
        
        .asset-meta {
            font-size: 0.75em;  /* Smaller metadata text */
            color: #4a5568;  /* Darker gray for better visibility */
            display: flex;
            justify-content: space-between;
            margin: 0;
            margin-top: auto; /* Push to bottom */
        }

        /* ENHANCED: Fullscreen modes with arrow key controls */
        .media-viewer-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.95);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .media-viewer-content {
            position: relative;
            width: 100vw;
            height: 100vh;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* ENHANCED: Multiple fullscreen modes */
        .media-viewer-image, .media-viewer-video {
            max-width: 98vw;
            max-height: 95vh;
            width: auto;
            height: auto;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            transition: all 0.3s ease;
        }

        /* Mode 1: Standard fullscreen */
        .media-viewer-modal.fullscreen .media-viewer-image,
        .media-viewer-modal.fullscreen .media-viewer-video {
            max-width: 100vw;
            max-height: 100vh;
            border-radius: 0;
        }

        /* Mode 2: Stretched fullscreen */
        .media-viewer-modal.fullscreen-stretched .media-viewer-image,
        .media-viewer-modal.fullscreen-stretched .media-viewer-video {
            width: 100vw !important;
            height: 100vh !important;
            max-width: 100vw;
            max-height: 100vh;
            object-fit: fill; /* Stretch to fill completely */
            border-radius: 0;
        }

        .media-viewer-modal.fullscreen,
        .media-viewer-modal.fullscreen-stretched {
            background: rgba(0, 0, 0, 1);
        }

        /* UI controls with enhanced z-index */
        .media-viewer-controls {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 2500;
        }

        .media-viewer-nav {
            position: fixed;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            color: white;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            z-index: 2500;
        }

        .media-viewer-nav:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-50%) scale(1.1);
        }

        .media-viewer-nav.prev {
            left: 20px;
        }

        .media-viewer-nav.next {
            right: 20px;
        }

        .media-viewer-info {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            backdrop-filter: blur(10px);
            z-index: 2500;
        }

        .media-viewer-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            color: white;
            font-size: 20px;
            cursor: pointer;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            z-index: 2500;
        }

        .media-viewer-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .media-viewer-fullscreen {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            color: white;
            font-size: 18px;
            cursor: pointer;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            z-index: 2500;
        }

        .media-viewer-fullscreen:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border: none;
            border-radius: 10px;
            padding: 12px 25px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .form-control, .form-select {
            border-radius: 10px;
            border: 2px solid #e5e7eb;
            padding: 12px 15px;
            transition: all 0.3s;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        
        .progress {
            height: 8px;
            border-radius: 10px;
            background-color: rgba(0,0,0,0.1);
        }
        
        .progress-bar {
            background: linear-gradient(90deg, var(--success-color), var(--primary-color));
            border-radius: 10px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #2d3748;  /* Dark gray for visibility */
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.9em;
            color: #718096;  /* Medium gray */
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .live-updates {
            max-height: 300px;
            overflow-y: auto;
            background: rgba(0,0,0,0.05);
            border-radius: 10px;
            padding: 15px;
        }
        
        .update-item {
            padding: 10px;
            border-bottom: 1px solid rgba(0,0,0,0.1);
            margin-bottom: 10px;
        }
        
        .update-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .update-time {
            color: #666;
            font-size: 0.8em;
        }
        
        .section {
            display: none;
        }
        
        .section.active {
            display: block;
        }
        
        .search-controls {
            background: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .source-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .source-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #e5e7eb;
            transition: all 0.3s;
        }
        
        .source-card.enabled {
            border-color: var(--success-color);
            background: rgba(16, 185, 129, 0.05);
        }
        
        .source-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .filter-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .filter-tab {
            padding: 10px 20px;
            border-radius: 20px;
            background: rgba(255,255,255,0.7);
            border: none;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .filter-tab.active {
            background: var(--primary-color);
            color: white;
        }

        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
        }

        .custom-toast {
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            border-left: 4px solid var(--primary-color);
        }

        /* ENHANCED: Checkbox with visible check mark */
        .asset-checkbox {
            position: absolute;
            top: 8px;
            left: 8px;
            z-index: 15;
            width: 18px;  /* Reduced from 22px */
            height: 18px; /* Reduced from 22px */
            cursor: pointer;
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid #666;  /* Darker border for visibility */
            border-radius: 4px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .asset-checkbox:checked {
            background-color: var(--primary-color) !important;
            border-color: var(--primary-color) !important;
            box-shadow: 0 3px 12px rgba(102, 126, 234, 0.6) !important;
        }

        .asset-checkbox:checked::after {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 12px;
            font-weight: bold;
            line-height: 1;
        }

        .asset-checkbox:focus {
            box-shadow: 0 0 0 0.3rem rgba(102, 126, 234, 0.6) !important;
        }

        .asset-checkbox:hover {
            border-color: var(--secondary-color) !important;
            box-shadow: 0 4px 16px rgba(0,0,0,0.6) !important;
        }

        /* GUARANTEED OVERLAY HIDING: Force all overlays to hide during hover */
        .video-preview-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 1;
            transition: opacity 0.2s ease;
            border-radius: 0;
            pointer-events: auto;
            z-index: 5;
        }

        /* ABSOLUTE HIDING: Multiple classes for consistency */
        .video-preview-overlay.force-hidden,
        .video-preview-overlay.hide-overlay,
        .video-card.playing .video-preview-overlay {
            opacity: 0 !important;
            pointer-events: none !important;
            visibility: hidden !important;
        }

        /* FIXED: Image elements within video-thumbnail containers */
        .video-thumbnail img.asset-preview {
            width: 100%;
            height: 150px;
            object-fit: cover;
            display: block;
            margin: 0;
            padding: 0;
            border: none;
            line-height: 0;
            font-size: 0;
            vertical-align: top;
            /* CRITICAL FIX: Use static positioning for images to display properly */
            position: static;
        }

        /* FIXED: Fallback divs for images within video-thumbnail containers */
        .video-thumbnail div.asset-preview {
            width: 100%;
            height: 150px;
            margin: 0;
            padding: 0;
            border: none;
            line-height: 0;
            font-size: 0;
            /* CRITICAL FIX: Use static positioning for fallback divs */
            position: static;
        }

        /* SEPARATE: Video-specific preview elements that need absolute positioning */
        .video-thumbnail .video-fallback-display {
            width: 100%;
            height: 150px;
            margin: 0;
            padding: 0;
            border: none;
            position: absolute;
            top: 0;
            left: 0;
        }

        /* UNIFIED: Canvas elements for video thumbnails */
        .video-thumbnail-canvas {
            width: 100%;
            height: 150px;
            object-fit: cover;
            display: block;
            margin: 0;
            padding: 0;
            position: absolute;
            top: 0;
            left: 0;
            transition: opacity 0.3s ease;
        }

        /* ENHANCED: Video hover functionality */
        .video-thumbnail video {
            width: 100%;
            height: 150px;
            object-fit: cover;
            display: none;
            margin: 0;
            padding: 0;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 3; /* Above canvas and overlay */
            transition: opacity 0.3s ease;
        }

        /* ENHANCED: Smooth transitions for video cards */
        .video-card .video-thumbnail * {
            transition: all 0.3s ease;
        }

        /* ENHANCED: Video card hover state */
        .video-card:hover .video-preview-overlay {
            opacity: 0.8;
        }

        .video-card:hover .play-button {
            transform: translate(-50%, -50%) scale(1.1);
        }

        .video-preview {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
            top: 0;
            left: 0;
            border-radius: 15px;
        }

        .asset-card.video-card {
            position: relative;
            overflow: hidden;
        }

        .play-button {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 24px;
            color: var(--primary-color);
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 10;
        }

        .play-button:hover {
            background: white;
            transform: translate(-50%, -50%) scale(1.1);
        }

        .media-counter {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            backdrop-filter: blur(10px);
        }

        .asset-card.selected {
            border: 3px solid var(--primary-color);
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        /* File Manager Styles */
        .file-manager-toolbar {
            background: white;
            padding: 15px 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .bulk-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .folder-path {
            background: rgba(102, 126, 234, 0.1);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            color: var(--primary-color);
        }

        .asset-card.selectable {
            position: relative;
        }

        .selection-info {
            background: var(--primary-color);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            margin-left: 10px;
            font-weight: 600;
        }

        .video-duration {
            position: absolute;
            bottom: 5px;
            right: 5px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: bold;
            z-index: 6;
        }

        .folder-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px dashed #e5e7eb;
        }

        .folder-card:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .folder-card.create-new {
            border-style: dashed;
            color: var(--primary-color);
        }

        .breadcrumb-nav {
            background: rgba(255, 255, 255, 0.9);
            padding: 10px 20px;
            border-radius: 25px;
            margin-bottom: 15px;
            backdrop-filter: blur(10px);
        }

        .breadcrumb-item {
            display: inline-block;
            color: var(--primary-color);
            text-decoration: none;
            padding: 5px 10px;
            border-radius: 15px;
            transition: background 0.3s ease;
        }

        .breadcrumb-item:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        .breadcrumb-item.active {
            background: var(--primary-color);
            color: white;
        }

        .file-details-panel {
            position: fixed;
            right: -400px;
            top: 0;
            width: 400px;
            height: 100vh;
            background: white;
            box-shadow: -5px 0 15px rgba(0,0,0,0.1);
            z-index: 1500;
            transition: right 0.3s ease;
            overflow-y: auto;
            padding: 20px;
        }

        .file-details-panel.open {
            right: 0;
        }

        .selection-info {
            background: var(--primary-color);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            margin-left: 10px;
            font-weight: 600;
        }

        .create-folder-modal .modal-content {
            border-radius: 15px;
            border: none;
        }

        .view-mode-toggle {
            display: flex;
            background: rgba(0,0,0,0.05);
            border-radius: 25px;
            padding: 3px;
        }

        .view-mode-btn {
            padding: 8px 15px;
            border: none;
            background: transparent;
            border-radius: 20px;
            transition: all 0.3s ease;
        }

        .view-mode-btn.active {
            background: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        /* PRECISION FIX: Image elements within video-thumbnail containers */
        .video-thumbnail img.asset-preview {
            width: 100% !important;
            height: 150px !important;
            object-fit: cover !important;
            display: block !important;
            margin: 0 !important;
            padding: 0 !important;
            border: none !important;
            line-height: 0 !important;
            font-size: 0 !important;
            vertical-align: top !important;
            position: static !important; /* Changed from relative to static for better display */
            top: auto !important;
            left: auto !important;
        }

        /* PRECISION FIX: Fallback divs within video-thumbnail containers */
        .video-thumbnail div.asset-preview {
            width: 100% !important;
            height: 150px !important;
            margin: 0 !important;
            padding: 0 !important;
            border: none !important;
            line-height: 1 !important;
            font-size: inherit !important;
            position: static !important; /* Changed from relative to static for better display */
            top: auto !important;
            left: auto !important;
        }

        /* Safe Search Styles */
        .safe-search-label {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .safe-search-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .toggle-switch {
            position: relative;
            width: 60px;
            height: 34px;
            display: inline-block;
        }

        .toggle-switch input[type="checkbox"] {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-label {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            border-radius: 34px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .toggle-label:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            border-radius: 50%;
            transition: transform 0.2s ease;
        }

        .toggle-switch input[type="checkbox"]:checked + .toggle-label {
            background-color: #4CAF50;
        }

        .toggle-switch input[type="checkbox"]:checked + .toggle-label:before {
            transform: translateX(26px);
        }

        .toggle-switch input[type="checkbox"]:not(:checked) + .toggle-label {
            background-color: #FF5722;
        }

        .safe-search-status {
            font-size: 14px;
            font-weight: 500;
            padding: 4px 8px;
            border-radius: 12px;
            background-color: rgba(76, 175, 80, 0.1);
            border: 1px solid #4CAF50;
        }

        .safe-search-status.off {
            background-color: rgba(255, 87, 34, 0.1);
            border-color: #FF5722;
            color: #FF5722;
        }

        /* Source Categories Styles */
        .source-categories {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            background-color: #f8f9fa;
        }

        .source-category {
            background-color: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .source-category:last-child {
            margin-bottom: 0;
        }

        .source-category.adult-category {
            border-color: #FF5722;
            background-color: #fff3e0;
        }

        .category-header {
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 8px;
            margin-bottom: 12px;
        }

        .category-header h6 {
            margin: 0;
            color: #495057;
            font-weight: 600;
        }

        .sources-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 8px;
        }

        .form-check-inline {
            margin-right: 0;
        }

        .form-check-input:checked {
            background-color: #0d6efd;
            border-color: #0d6efd;
        }

        .source-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .source-controls button {
            flex: 1;
            min-width: 120px;
        }

        /* ENHANCED: Asset Section Organization */
        .asset-section {
            margin-bottom: 40px;
            border-radius: 15px;
            overflow: hidden;
        }

        .section-title {
            padding: 20px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            margin: 0 0 25px 0;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 15px;
            border-radius: 15px 15px 0 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .section-title i {
            font-size: 1.5em;
            opacity: 0.9;
        }

        /* ENHANCED: Video hover preview functionality */
        .video-preview-container {
            position: relative;
            width: 100%;
            height: 150px;
            background: var(--light-color);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border-radius: 8px 8px 0 0;
        }

        .video-play-icon {
            position: absolute;
            z-index: 10;
            color: var(--primary-color);
            transition: all 0.3s ease;
            opacity: 0.8;
        }

        .video-hover-preview {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
            transition: opacity 0.3s ease;
        }

        .asset-card:hover .video-play-icon {
            transform: scale(1.2);
            opacity: 1;
        }

        /* ENHANCED: Better asset preview images */
        .asset-preview {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 8px 8px 0 0;
            transition: transform 0.3s ease;
        }

        .asset-card:hover .asset-preview {
            transform: scale(1.05);
        }

        /* ENHANCED: Improved checkbox visibility */
        .asset-checkbox {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 15;
            transform: scale(1.4);
            background: rgba(255, 255, 255, 0.9);
            border-radius: 4px;
            padding: 2px;
        }

        /* ENHANCED: Media viewer improvements */
        .media-viewer-modal {
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }

        .media-viewer-nav {
            opacity: 0.7;
            transition: all 0.3s ease;
        }

        .media-viewer-nav:hover {
            opacity: 1;
            background: rgba(255, 255, 255, 0.4);
        }

        .media-viewer-nav:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        /* ENHANCED: Keyboard shortcuts display */
        .keyboard-shortcuts {
            position: fixed;
            bottom: 70px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 12px;
            backdrop-filter: blur(10px);
            z-index: 2500;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .media-viewer-modal:hover .keyboard-shortcuts {
            opacity: 1;
        }

        /* ENHANCED: Loading states */
        .asset-card.loading .video-thumbnail {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* ENHANCED: Custom toast notifications */
        .custom-toast {
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            border-left: 4px solid var(--primary-color);
        }

        /* ENHANCED: Keyboard shortcut styling */
        kbd {
            background-color: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            padding: 2px 6px;
            font-size: 11px;
            font-family: monospace;
            color: white;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        /* ENHANCED: Better scrollbar for webkit browsers - More visible */
        ::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.15);
            border-radius: 6px;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-radius: 6px;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
        }

        ::-webkit-scrollbar-corner {
            background: rgba(0, 0, 0, 0.1);
        }

        /* ENHANCED: Asset grid scrolling container - More visible scrollbar */
        #assetsGrid {
            max-height: 70vh;
            overflow-y: auto;
            padding-right: 15px;
            scroll-behavior: smooth;
            /* Force scrollbar to be visible */
            scrollbar-width: auto;
            scrollbar-color: var(--primary-color) rgba(0, 0, 0, 0.1);
        }

        /* Enhanced selection controls */
        .bulk-selection-toolbar {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 15px 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: none;
            align-items: center;
            justify-content: space-between;
            gap: 15px;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .bulk-selection-toolbar.active {
            display: flex;
        }

        .selection-info {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
        }

        .bulk-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .bulk-actions .btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            transition: all 0.3s ease;
        }

        .bulk-actions .btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            color: white;
            transform: translateY(-2px);
        }

        /* Enhanced checkbox styling with visibility */
        .asset-checkbox {
            position: absolute;
            top: 12px;
            left: 12px;
            z-index: 15;
            width: 22px;
            height: 22px;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid #ccc;
            border-radius: 6px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .asset-checkbox:checked {
            background: var(--primary-color);
            border-color: var(--primary-color);
            box-shadow: 0 3px 12px rgba(102, 126, 234, 0.6);
        }

        .asset-checkbox:checked::after {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 14px;
            font-weight: bold;
            line-height: 1;
        }

        .asset-checkbox:hover {
            border-color: var(--secondary-color);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);
            transform: scale(1.1);
        }

        .asset-card.selected {
            border: 3px solid var(--primary-color);
            transform: translateY(-3px);
            box-shadow: 0 12px 30px rgba(102, 126, 234, 0.4);
        }

        /* Video thumbnail immediate display - fix for blank thumbnails */
        .video-thumbnail-canvas {
            width: 100%;
            height: 150px;
            object-fit: cover;
            display: block; /* Changed from none to block for immediate display */
            margin: 0;
            padding: 0;
            position: absolute;
            top: 0;
            left: 0;
            transition: opacity 0.3s ease;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .video-thumbnail-fallback {
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: opacity 0.3s ease;
        }

        /* Hide fallback when canvas is loaded */
        .video-thumbnail-canvas.loaded + .video-thumbnail-fallback {
            display: none;
        }

        /* Master select checkbox */
        .master-select-checkbox {
            margin-right: 15px;
            transform: scale(1.3);
            cursor: pointer;
        }

        /* ENHANCED: Navigation info text */
        #navigationInfo {
            font-size: 0.85em;
            color: #6c757d;
            font-style: italic;
        }

        /**
         * ============================================================================
         * ENHANCED CSS STYLING FOR VIDEO THUMBNAILS
         * ============================================================================
         * 
         * CRITICAL: These styles support the enhanced video thumbnail functionality
         * DO NOT MODIFY these styles as they ensure proper thumbnail display and
         * maintain the 5-per-row grid layout
         */

        /* Enhanced Video Thumbnail Container */
        .video-thumbnail-container {
            width: 100%;
            height: 150px;
            position: relative;
            overflow: hidden;
            border-radius: 8px 8px 0 0;
            background: var(--light-color);
        }

        /* Video Thumbnail Canvas (Generated Thumbnails) */
        .video-thumbnail-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: opacity 0.3s ease;
        }

        /* Video Thumbnail Fallback (Gradient Background) */
        .video-thumbnail-fallback {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: opacity 0.3s ease;
        }

        /* Video Format Badge */
        .video-format-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7em;
            text-transform: uppercase;
            font-weight: 600;
            z-index: 15;
        }

        /* Enhanced Video Hover Preview */
        .video-hover-preview {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 5;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        /* Enhanced Video Play Icon */
        .video-play-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 2.5em;
            text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.8);
            z-index: 10;
            transition: all 0.3s ease;
            opacity: 0.9;
            cursor: pointer;
        }

        /* Video Card Hover Effects */
        .video-card:hover .video-play-icon {
            transform: translate(-50%, -50%) scale(1.1);
            opacity: 1;
        }

        /* Video Duration Display */
        .video-duration {
            font-family: 'Courier New', monospace;
            font-size: 0.75em;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 2px 4px;
            border-radius: 3px;
        }

        /* Video Thumbnail Source (Hidden) */
        .video-thumbnail-source {
            display: none;
        }

        /**
         * ============================================================================
         * LEGACY COMPATIBILITY STYLES
         * ============================================================================
         * 
         * These maintain compatibility with existing functionality
         */
        
        .video-thumbnail {
            width: 100%;
            height: 150px;
            background: var(--light-color);
            display: block;
            margin: 0;
            padding: 0;
            border: none;
            line-height: 0;
            font-size: 0;
            vertical-align: top;
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
        }

        /* Master select checkbox */
        .master-select-checkbox {
            margin-right: 15px;
            transform: scale(1.3);
            cursor: pointer;
        }

        /* ENHANCED: Filter button active states */
        .btn-group .btn.active {
            background: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
            box-shadow: 0 3px 12px rgba(102, 126, 234, 0.3);
        }

        /* ENHANCED: Navigation info text */
        #navigationInfo {
            font-size: 0.85em;
            color: #6c757d;
            font-style: italic;
        }

        /* Firefox scrollbar styling */
        #assetsGrid {
            scrollbar-width: auto;
            scrollbar-color: var(--primary-color) rgba(0, 0, 0, 0.15);
        }

        /* Ensure video thumbnails load properly */
        .video-thumbnail-source {
            opacity: 0;
            position: absolute;
            top: -9999px;
        }

        /* Smooth checkbox transitions */
        .asset-checkbox {
            transition: all 0.2s ease;
        }

        /* Better contrast for selected items */
        .asset-card.selected .asset-info {
            background: rgba(102, 126, 234, 0.05);
        }

        /* Enhanced dropdown menu styling */
        .dropdown-menu {
            border: none;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            border-radius: 12px;
            padding: 8px 0;
            min-width: 250px;
            margin-top: 8px;
            /* Force dropdown to stay on screen */
            right: 0 !important;
            left: auto !important;
            transform: none !important;
            position: absolute !important;
        }
        
        /* Ensure dropdown container has proper positioning */
        .dropdown {
            position: relative;
        }
        
        /* Force dropdown-menu-end to align right */
        .dropdown-menu-end {
            --bs-position: end;
            right: 0 !important;
            left: auto !important;
        }
        
        .dropdown-menu .dropdown-header {
            padding: 12px 16px;
            font-size: 0.9rem;
        }
        
        .dropdown-menu .dropdown-item {
            padding: 10px 16px;
            transition: all 0.2s ease;
            border-radius: 0;
        }
        
        .dropdown-menu .dropdown-item:hover {
            background-color: rgba(102, 126, 234, 0.1);
            color: var(--primary-color);
        }
        
        .dropdown-menu .dropdown-item.text-danger:hover {
            background-color: rgba(220, 53, 69, 0.1);
            color: #dc3545;
        }
        
        /* Ensure dropdown shows properly */
        .dropdown-menu.show {
            display: block !important;
            opacity: 1;
            transform: translateY(0);
            animation: dropdownShow 0.15s ease-out;
            /* Ensure it's visible */
            visibility: visible !important;
            right: 0 !important;
            left: auto !important;
        }
        
        @keyframes dropdownShow {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Help modal keyboard shortcuts styling */
        .shortcut-list {
            list-style: none;
            padding: 0;
        }
        
        .shortcut-list div {
            margin: 8px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .shortcut-list kbd {
            min-width: 30px;
            text-align: center;
        }
        
        /* Settings dropdown styling */
        .dropdown-menu {
            border: none;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            border-radius: 12px;
            padding: 8px 0;
            min-width: 200px;
            margin-top: 8px;
        }

        /* Enhanced asset card with glass morphism effect */
        .asset-card {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            transition: all 0.3s ease;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            position: relative;
            border: 3px solid transparent;
        }

        /* Bulk selection toolbar */
        .bulk-selection-toolbar {
            display: none;
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(102, 126, 234, 0.95);
            color: white;
            padding: 15px 30px;
            border-radius: 50px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            align-items: center;
            gap: 20px;
            backdrop-filter: blur(10px);
        }

        .bulk-selection-toolbar .selection-info {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
        }

        .bulk-selection-toolbar .bulk-actions {
            display: flex;
            gap: 10px;
        }

        .bulk-selection-toolbar .btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 25px;
            transition: all 0.3s ease;
        }

        .bulk-selection-toolbar .btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        /* Master select checkbox styling */
        .master-select-checkbox {
            width: 16px;  /* Smaller size */
            height: 16px;
            margin-right: 10px;
            cursor: pointer;
            accent-color: var(--primary-color);
        }
        
        /* Fix text visibility - ensure all text is readable */
        .text-muted {
            color: #718096 !important;  /* Medium gray instead of too light */
        }
        
        /* Fix navigation info text */
        #navigationInfo {
            font-size: 0.85em;
            color: #4a5568;  /* Darker gray */
            font-style: italic;
        }

        /* Download Command Center Styles */
        .download-command-center {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: var(--command-center-bg);
            z-index: 3000;
            overflow-y: auto;
            backdrop-filter: blur(20px);
        }
        
        .command-center-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 5px 20px var(--shadow-color);
        }
        
        .command-center-content {
            padding: 30px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .main-progress-section {
            background: var(--bg-card);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px var(--shadow-color);
            border: 1px solid var(--border-color);
        }
        
        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .progress-percentage {
            font-size: 2em;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .stats-grid-enhanced {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card-enhanced {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px var(--shadow-color);
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 15px;
            transition: transform 0.3s ease;
        }
        
        .stat-card-enhanced:hover {
            transform: translateY(-5px);
        }
        
        .stat-icon {
            font-size: 2.5em;
            color: var(--primary-color);
            opacity: 0.8;
        }
        
        .stat-content {
            flex: 1;
        }
        
        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: var(--text-primary);
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.9em;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .activity-feed-section {
            background: var(--bg-card);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px var(--shadow-color);
            border: 1px solid var(--border-color);
        }
        
        .activity-feed {
            max-height: 300px;
            overflow-y: auto;
            padding: 15px;
            background: var(--bg-primary);
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            line-height: 1.6;
            color: var(--text-primary);
        }
        
        .activity-item {
            padding: 5px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .activity-message {
            color: var(--text-primary);
        }
        
        /* Process Indicator - Fixed positioning */
        .process-indicator {
            position: fixed;
            top: 80px; /* Below navbar */
            right: 20px;
            background: var(--bg-card);
            border-radius: 10px;
            padding: 15px 20px;
            box-shadow: 0 4px 20px var(--shadow-color);
            display: none;
            align-items: center;
            gap: 15px;
            z-index: 2500; /* Above content but below command center */
            min-width: 250px;
            border: 1px solid var(--border-color);
        }
        
        .process-pulse {
            width: 12px;
            height: 12px;
            background: white;
            border-radius: 50%;
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.2); }
            100% { opacity: 1; transform: scale(1); }
        }
        
        .process-text {
            font-weight: 600;
        }
        
        .process-count {
            background: rgba(255, 255, 255, 0.3);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.9em;
        }

        /* File Explorer Styles */
        .file-explorer-container {
            min-height: 400px;
        }
        
        .explorer-breadcrumb {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 1.1em;
            color: #2d3748;
        }
        
        .explorer-toolbar {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
        }
        
        .container-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            min-height: 300px;
        }
        
        .container-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            padding: 20px;
            background: white;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .container-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border-color: var(--primary-color);
        }
        
        .container-item.selected {
            background: rgba(102, 126, 234, 0.1);
            border-color: var(--primary-color);
        }
        
        .container-item i {
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        
        .container-name {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 5px;
            word-break: break-word;
        }
        
        .container-count {
            font-size: 0.85em;
            color: #718096;
        }
        
        .selected-container-info {
            margin-top: 20px;
            padding: 15px;
            background: #e6f7ff;
            border-radius: 10px;
            text-align: center;
        }
        
        #selectedContainerName {
            font-weight: 600;
            color: var(--primary-color);
        }
    
        /* Sources Grid Layout */
        .sources-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .source-card {
            background: var(--bs-body-bg);
            border: 1px solid var(--bs-border-color);
            border-radius: 8px;
            padding: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .source-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .source-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .source-icon {
            font-size: 24px;
            margin-right: 10px;
        }
        
        .source-title {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
        }
        
        .source-description {
            color: var(--bs-secondary-color);
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .source-stats {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            font-size: 13px;
            color: var(--bs-secondary-color);
        }
        
        .stat-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        /* System Status Improvements */
        .system-status {
            background: var(--bs-body-bg);
            border: 1px solid var(--bs-border-color);
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 30px;
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .status-item {
            background: var(--bs-gray-100);
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }
        
        .dark-mode .status-item {
            background: var(--bs-gray-800);
        }
        
        .status-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--bs-primary);
            display: block;
            margin-bottom: 5px;
        }
        
        .status-label {
            font-size: 14px;
            color: var(--bs-secondary-color);
        }
        
        /* Video Thumbnail Fixes */
        .asset-card img,
        .asset-card video {
            width: 100%;
            height: 200px;
            object-fit: cover;
            background: var(--bs-gray-200);
        }
        
        .dark-mode .asset-card img,
        .dark-mode .asset-card video {
            background: var(--bs-gray-700);
        }
        
        /* Video Hover Autoplay */
        .asset-card:hover video {
            display: block;
        }
        
        .asset-card:hover img.video-thumbnail {
            display: none;
        }
        
        /* Title Dark Mode Fix */
        .navbar-brand {
            color: var(--bs-navbar-brand-color) !important;
        }
        
        /* Sign Out Button Fix */
        .user-menu {
            position: relative;
        }
        
        .user-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--bs-body-bg);
            border: 1px solid var(--bs-border-color);
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            min-width: 200px;
            z-index: 1000;
            display: none;
        }
        
        .user-menu:hover .user-dropdown,
        .user-dropdown:hover {
            display: block;
        }
        
        /* Image Viewer Improvements */
        .image-viewer {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.95);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
        }
        
        .image-viewer.active {
            display: flex;
        }
        
        .viewer-content {
            max-width: 90%;
            max-height: 90%;
            position: relative;
        }
        
        .viewer-controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            padding: 10px 20px;
            border-radius: 30px;
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .viewer-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0,0,0,0.8);
            color: white;
            border: none;
            padding: 20px;
            cursor: pointer;
            font-size: 24px;
            border-radius: 4px;
            transition: all 0.3s ease;
        }
        
        .viewer-nav:hover {
            background: rgba(0,0,0,0.9);
        }
        
        .viewer-nav.prev {
            left: 20px;
        }
        
        .viewer-nav.next {
            right: 20px;
        }
        
        .viewer-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            color: white;
            border: none;
            padding: 10px 15px;
            cursor: pointer;
            font-size: 20px;
            border-radius: 4px;
        }
    
    
        /* Additional fixes for reported issues */
        
        /* Fix navbar brand for dark mode */
        .navbar-brand {
            color: var(--bs-navbar-color) !important;
            transition: color 0.3s ease;
        }
        
        .dark-mode .navbar-brand {
            color: #ffffff !important;
        }
        
        /* Fix user dropdown visibility */
        .user-dropdown {
            display: none !important;
        }
        
        .user-menu:hover .user-dropdown {
            display: block !important;
        }
        
        /* Video thumbnail consistency */
        .asset-card {
            position: relative;
            overflow: hidden;
        }
        
        .asset-card img,
        .asset-card video {
            width: 100%;
            height: 200px;
            object-fit: cover;
            background-color: #f0f0f0;
        }
        
        .dark-mode .asset-card img,
        .dark-mode .asset-card video {
            background-color: #2a2a2a;
        }
        
        /* Video hover preview */
        .asset-card video.preview {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 200px;
            object-fit: cover;
            display: none;
            z-index: 2;
        }
        
        .asset-card:hover video.preview {
            display: block;
        }
        
        /* System status spacing */
        .system-status {
            padding: 30px;
            margin-bottom: 40px;
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 25px;
            margin-top: 25px;
        }
        
        .status-item {
            padding: 20px;
            background: rgba(0, 123, 255, 0.1);
            border-radius: 10px;
            text-align: center;
            transition: transform 0.2s ease;
        }
        
        .status-item:hover {
            transform: translateY(-2px);
        }
        
        .dark-mode .status-item {
            background: rgba(255, 255, 255, 0.1);
        }
    
    </style>
</head>
<body>
    <!-- Download Command Center -->
    <div id="downloadCommandCenter" class="download-command-center" style="display: none;">
        <div class="command-center-header">
            <h3><i class="fas fa-download"></i> Download Command Center</h3>
            <button class="btn btn-sm btn-outline-light" onclick="minimizeCommandCenter()">
                <i class="fas fa-window-minimize"></i>
            </button>
        </div>
        
        <div class="command-center-content">
            <!-- Main Progress -->
            <div class="main-progress-section">
                <div class="progress-header">
                    <h4 id="mainProgressLabel">Initializing...</h4>
                    <span class="progress-percentage" id="mainProgressPercent">0%</span>
                </div>
                <div class="progress" style="height: 25px;">
                    <div id="mainProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" style="width: 0%;">
                    </div>
                </div>
            </div>
            
            <!-- Statistics Grid -->
            <div class="stats-grid-enhanced">
                <div class="stat-card-enhanced">
                    <div class="stat-icon"><i class="fas fa-search"></i></div>
                    <div class="stat-content">
                        <div class="stat-value" id="totalScanned">0</div>
                        <div class="stat-label">Files Scanned</div>
                    </div>
                </div>
                <div class="stat-card-enhanced">
                    <div class="stat-icon"><i class="fas fa-download"></i></div>
                    <div class="stat-content">
                        <div class="stat-value" id="totalDownloaded">0</div>
                        <div class="stat-label">Downloaded</div>
                    </div>
                </div>
                <div class="stat-card-enhanced">
                    <div class="stat-icon"><i class="fas fa-percentage"></i></div>
                    <div class="stat-content">
                        <div class="stat-value" id="successRateValue">0%</div>
                        <div class="stat-label">Success Rate</div>
                    </div>
                </div>
                <div class="stat-card-enhanced">
                    <div class="stat-icon"><i class="fas fa-hdd"></i></div>
                    <div class="stat-content">
                        <div class="stat-value" id="totalSize">0 MB</div>
                        <div class="stat-label">Total Size</div>
                    </div>
                </div>
                <div class="stat-card-enhanced">
                    <div class="stat-icon"><i class="fas fa-tachometer-alt"></i></div>
                    <div class="stat-content">
                        <div class="stat-value" id="downloadSpeed">0 KB/s</div>
                        <div class="stat-label">Speed</div>
                    </div>
                </div>
                <div class="stat-card-enhanced">
                    <div class="stat-icon"><i class="fas fa-clock"></i></div>
                    <div class="stat-content">
                        <div class="stat-value" id="timeElapsed">00:00</div>
                        <div class="stat-label">Time Elapsed</div>
                    </div>
                </div>
            </div>
            
            <!-- Content Type Breakdown -->
            <div class="content-breakdown">
                <div class="breakdown-item">
                    <i class="fas fa-image"></i>
                    <span class="breakdown-label">Images:</span>
                    <span class="breakdown-value" id="imageCount">0</span>
                </div>
                <div class="breakdown-item">
                    <i class="fas fa-video"></i>
                    <span class="breakdown-label">Videos:</span>
                    <span class="breakdown-value" id="videoCount">0</span>
                </div>
            </div>
            
            <!-- Source Progress -->
            <div class="source-progress-section">
                <h5><i class="fas fa-layer-group"></i> Source Progress</h5>
                <div id="sourceProgressContainer">
                    <!-- Dynamically populated source progress bars -->
                </div>
            </div>
            
            <!-- Live Activity Feed -->
            <div class="activity-feed-section">
                <h5><i class="fas fa-stream"></i> Live Activity</h5>
                <div id="activityFeed" class="activity-feed">
                    <!-- Live updates will appear here -->
                </div>
            </div>
            
            <!-- Active Threads/Processes -->
            <div class="threads-section">
                <h5><i class="fas fa-microchip"></i> Active Processes</h5>
                <div id="activeThreads" class="threads-container">
                    <div class="thread-item">
                        <span class="thread-id">Thread 1</span>
                        <span class="thread-status">Downloading...</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="command-center-footer">
            <button class="btn btn-warning" onclick="pauseDownload()" id="pauseBtn">
                <i class="fas fa-pause"></i> Pause
            </button>
            <button class="btn btn-danger" onclick="cancelDownload()">
                <i class="fas fa-stop"></i> Cancel
            </button>
        </div>
    </div>
    
    <!-- Minimized Process Indicator -->
    <div id="processIndicator" class="process-indicator" style="display: none;">
        <div class="process-pulse"></div>
        <span class="process-text">Processing...</span>
        <span class="process-count" id="miniProcessCount">0</span>
        <button class="btn btn-sm btn-link text-white" onclick="showCommandCenter()">
            <i class="fas fa-expand"></i>
        </button>
    </div>
    
    <!-- Top Navigation Bar with Authentication -->
    <nav class="navbar navbar-expand-lg navbar-dark position-fixed w-100" style="top: 0; left: 0; z-index: 2000; backdrop-filter: blur(10px); background: var(--navbar-bg) !important; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
        <div class="container-fluid px-4">
            <a href="/" class="navbar-brand d-flex align-items-center text-decoration-none">
                <i class="fas fa-download me-2"></i>
                <span class="site-title">Enhanced Media Scraper</span>
            </a>
            
            <!-- Theme Toggle -->
            <button id="themeToggle" class="btn btn-outline-light btn-sm ms-3" title="Toggle theme">
                <i class="fas fa-moon" id="themeIcon"></i>
            </button>
            
            <!-- Empty center area for spacing -->
            <div class="mx-auto"></div>
            
            <div class="d-flex align-items-center gap-3">
                <!-- Authentication Section -->
                {% if user_info.authenticated %}
                    <!-- Credits Display -->
                    <div class="credits-display" id="creditsDisplay">
                        <i class="fas fa-coins"></i>
                        <span>Credits: <span class="credits-count" id="userCreditsCount">0</span></span>
                    </div>
                    
                    <!-- Subscription Badge -->
                    <div class="subscription-badge me-2" id="userPlanBadge"></div>
                    
                    <!-- User Avatar/Initials Badge for Authenticated Users -->
                    <div class="dropdown">
                        <button class="btn p-0 border-0" type="button" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">
                            <div class="user-avatar-badge">
                                {% set first_initial = user_info.user.name.split()[0][0].upper() if user_info.user.name else user_info.user.email[0].upper() %}
                                {% set last_initial = user_info.user.name.split()[1][0].upper() if user_info.user.name and user_info.user.name.split()|length > 1 else '' %}
                                {{ first_initial }}{{ last_initial }}
                            </div>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                            <li><h6 class="dropdown-header">
                                <i class="fas fa-user-circle"></i> {{ user_info.user.name or user_info.user.email }}
                            </h6></li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <a class="dropdown-item" href="{{ url_for('subscription.account') }}">
                                    <i class="fas fa-crown"></i> My Subscription
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="{{ url_for('subscription.plans') }}">
                                    <i class="fas fa-rocket"></i> Upgrade Plan
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <a class="dropdown-item" href="#" onclick="showAccountSettings()">
                                    <i class="fas fa-user-cog"></i> Account Settings
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="#" onclick="showAppSettings()">
                                    <i class="fas fa-cogs"></i> App Settings
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <a class="dropdown-item" href="#" onclick="showThemeSelector()">
                                    <i class="fas fa-palette"></i> Theme
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="#" onclick="showLanguageSelector()">
                                    <i class="fas fa-language"></i> Language
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="#" onclick="showHelp()">
                                    <i class="fas fa-question-circle"></i> Help
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <a class="dropdown-item text-danger" href="{{ url_for('auth.logout') }}">
                                    <i class="fas fa-sign-out-alt"></i> Sign Out
                                </a>
                            </li>
                        </ul>
                    </div>
                {% else %}
                    <!-- Sign In Button for Guest Users (Make it more visible) -->
                    <a href="{{ url_for('auth.login') }}" class="btn btn-light btn-lg" style="background: white; color: var(--primary-color); border: 2px solid white; font-weight: 600; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
                        <i class="fab fa-google me-2"></i> Sign In with Google
                    </a>
                {% endif %}
            </div>
        </div>
    </nav>

    <div class="main-container" style="margin-top: 80px;">
        <!-- Sidebar Navigation -->
        <div class="sidebar">
            <div class="text-center mb-4">
                <h4 class="mb-2">
                    <i class="fas fa-download text-primary"></i>
                    Media Scraper
                </h4>
                <span class="badge bg-success">v2.0 Pro</span>
            </div>
            
            <nav>
                <div class="nav-item active" onclick="showSection('dashboard')">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </div>
                <div class="nav-item" onclick="showSection('search')">
                    <i class="fas fa-search"></i>
                    <span>Search & Download</span>
                </div>
                <div class="nav-item" onclick="showSection('assets')">
                    <i class="fas fa-images"></i>
                    <span>Assets Library</span>
                </div>
                <div class="nav-item" onclick="showSection('settings')">
                    <i class="fas fa-sliders-h"></i>
                    <span>Settings</span>
                </div>
            </nav>
            
            <!-- System Status -->
            <div class="mt-4 p-3 bg-light rounded">
                <h6><i class="fas fa-server"></i> System Status</h6>
                <div class="d-flex justify-content-between">
                    <small>Server:</small>
                    <span class="badge bg-success">Online</span>
                </div>
                <div class="d-flex justify-content-between">
                    <small>Sources:</small>
                    <span class="badge bg-info" id="activeSources">17</span>
                </div>
                <div class="d-flex justify-content-between">
                    <small>Jobs:</small>
                    <span class="badge bg-warning" id="activeJobs">0</span>
                </div>
            </div>
        </div>
        
        <!-- Main Content Area -->
        <div class="content-area">
            <!-- Dashboard Section -->
            <div id="dashboard-section" class="section active">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="fas fa-tachometer-alt"></i> Dashboard</h2>
                    <button class="btn btn-primary" onclick="showSection('search')">
                        <i class="fas fa-plus"></i> New Search
                    </button>
                </div>
                
                <!-- Statistics Grid -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalDownloads">0</div>
                        <div class="stat-label">Total Downloads</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalImages">0</div>
                        <div class="stat-label">Images</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalVideos">0</div>
                        <div class="stat-label">Videos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="successRate">85%</div>
                        <div class="stat-label">Success Rate</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalSize">0 MB</div>
                        <div class="stat-label">Total Size</div>
                    </div>
                </div>
                
                <!-- Recent Activity -->
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-clock"></i> Recent Activity</h5>
                    </div>
                    <div class="card-body">
                        <div id="recentActivity">
                            <div class="text-muted text-center py-3">
                                <i class="fas fa-rocket fa-2x mb-2"></i><br>
                                System ready! Start a search to see activity updates here.
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Recent Downloads Preview -->
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-download"></i> Recent Downloads</h5>
                    </div>
                    <div class="card-body">
                        <div id="recentDownloads" class="asset-grid">
                            <div class="text-muted text-center py-3">
                                <i class="fas fa-images fa-2x mb-2"></i><br>
                                No downloads yet. Use Search & Download to start collecting content.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Search Section -->
            <div id="search-section" class="section">
                <h2><i class="fas fa-search"></i> Search & Download</h2>
                
                <div class="search-controls">
                    <form id="searchForm">
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">
                                    <i class="fas fa-search"></i> Search Query / Username / URL
                                </label>
                                <input type="text" class="form-control" id="searchQuery" 
                                       placeholder="Enter keywords, @username, or URL..." required>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Search Type</label>
                                <select class="form-select" id="searchType">
                                    <option value="comprehensive">🚀 Comprehensive</option>
                                    <option value="images">🖼️ Images Only</option>
                                    <option value="videos">🎬 Videos Only</option>
                                    <option value="instagram">📸 Instagram</option>
                                    <option value="reddit">🔴 Reddit</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Max Items</label>
                                <input type="number" class="form-control" id="maxItems" value="25" min="5" max="100">
                            </div>
                        </div>
                        
                        <!-- Safe Search and Sources Controls -->
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <!-- Safe Search Toggle -->
                                <div class="form-group">
                                    <label class="form-label safe-search-label">
                                        <i class="fas fa-shield-alt"></i> Safe Search
                                    </label>
                                    <div class="safe-search-container">
                                        <div class="toggle-switch">
                                            <input type="checkbox" id="safeSearchToggle" checked>
                                            <label for="safeSearchToggle" class="toggle-label">
                                                <span class="toggle-inner"></span>
                                            </label>
                                        </div>
                                        <span class="safe-search-status" id="safeSearchStatus">ON (Adult content hidden)</span>
                                    </div>
                                    <small class="form-text text-muted">
                                        <i class="fas fa-info-circle"></i> 
                                        When disabled, adult content sources will be available (18+ only)
                                    </small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <!-- Content Sources -->
                                <div class="form-group">
                                    <label class="form-label">
                                        <i class="fas fa-layer-group"></i> Content Sources
                                        <span class="source-count" id="sourceCount">(Loading...)</span>
                                    </label>
                                    
                                    <!-- Source Categories -->
                                    <div id="sourceCategories" class="source-categories">
                                        <!-- Sources will be populated here -->
                                    </div>
                                    
                                    <div class="source-controls">
                                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="toggleAllSources(true)">
                                            <i class="fas fa-check-square"></i> Select All
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="toggleAllSources(false)">
                                            <i class="fas fa-square"></i> Deselect All
                                        </button>
                                        <button type="button" class="btn btn-outline-info btn-sm" onclick="refreshSources()">
                                            <i class="fas fa-sync-alt"></i> Refresh
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mt-3">
                            <div class="col-md-12">
                                <button type="submit" class="btn btn-primary btn-lg w-100">
                                    <i class="fas fa-rocket"></i> Start Search
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
                
                <!-- Progress Panel -->
                <div id="progressPanel" class="card status-panel">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-tasks"></i> Download Progress
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Main Progress Bar -->
                        <div class="mb-3">
                            <label id="progressLabel" class="form-label">Initializing...</label>
                            <div class="progress" style="height: 20px;">
                                <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                                     role="progressbar" style="width: 0%;">
                                    <span id="progressPercent">0%</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Enhanced Stats Grid -->
                        <div class="stats-grid mb-3">
                            <div class="stat-card">
                                <div class="stat-value" id="currentScanned">0</div>
                                <div class="stat-label">Files Scanned</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="currentDownloaded">0</div>
                                <div class="stat-label">Downloaded</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="successRate">0%</div>
                                <div class="stat-label">Success Rate</div>
                            </div>
                        </div>
                        
                        <!-- File Type Breakdown -->
                        <div class="row mb-3">
                            <div class="col-6">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-image text-primary me-2"></i>
                                    <span class="flex-grow-1">Images:</span>
                                    <span class="badge bg-primary" id="currentImages">0</span>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-video text-danger me-2"></i>
                                    <span class="flex-grow-1">Videos:</span>
                                    <span class="badge bg-danger" id="currentVideos">0</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Per-Source Progress -->
                        <div id="sourceProgress" class="mb-3">
                            <h6 class="text-muted mb-2">Source Progress</h6>
                            <div id="sourceProgressList" class="small">
                                <!-- Dynamically populated -->
                            </div>
                        </div>
                        
                        <!-- Live Updates -->
                        <div id="liveUpdates" class="small text-muted" style="max-height: 150px; overflow-y: auto;">
                            <!-- Live updates will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Assets Section -->
            <div id="assets-section" class="section">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="fas fa-images"></i> Assets Library</h2>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-primary" onclick="refreshAssets()">
                            <i class="fas fa-sync"></i> Refresh
                        </button>
                        <button class="btn btn-outline-success" onclick="showCreateFolderModal()">
                            <i class="fas fa-folder-plus"></i> New Folder
                        </button>
                    </div>
                </div>

                <!-- Asset Navigation Bar -->
                <div class="card mb-4">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <!-- Filter Buttons with Master Select -->
                            <div class="d-flex align-items-center">
                                <input type="checkbox" class="form-check-input master-select-checkbox" id="masterSelect" onchange="toggleSelectAll(this.checked)" title="Select All">
                                <div class="btn-group" role="group" aria-label="Asset filters">
                                    <button type="button" class="btn btn-outline-primary active" id="filterAll" onclick="filterAssets('all')">
                                        <i class="fas fa-th"></i> All (<span id="allCount">0</span>)
                                    </button>
                                    <button type="button" class="btn btn-outline-success" id="filterImages" onclick="filterAssets('images')">
                                        <i class="fas fa-images"></i> Images (<span id="imagesCount">0</span>)
                                    </button>
                                    <button type="button" class="btn btn-outline-danger" id="filterVideos" onclick="filterAssets('videos')">
                                        <i class="fas fa-video"></i> Videos (<span id="videosCount">0</span>)
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Navigation Info Only -->
                            <div class="d-flex align-items-center">
                                <span class="text-muted" id="navigationInfo">Navigate with ↑↓ arrow keys</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bulk Selection Toolbar -->
                <div class="bulk-selection-toolbar" id="bulkSelectionToolbar">
                    <div class="selection-info">
                        <i class="fas fa-check-circle"></i>
                        <span id="selectedCount">0</span> selected
                    </div>
                    <div class="bulk-actions">
                        <button class="btn btn-sm" onclick="downloadSelected()" title="Download Selected">
                            <i class="fas fa-download"></i> Download
                        </button>
                        <button class="btn btn-sm" onclick="moveSelected()" title="Move Selected">
                            <i class="fas fa-folder-open"></i> Move
                        </button>
                        <button class="btn btn-sm" onclick="deleteSelected()" title="Delete Selected">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                        <button class="btn btn-sm" onclick="clearSelection()" title="Clear Selection">
                            <i class="fas fa-times"></i> Clear
                        </button>
                    </div>
                </div>

                <!-- Breadcrumb Navigation -->
                <div class="breadcrumb-nav">
                    <span id="folderBreadcrumb">
                        <a href="#" class="breadcrumb-item active" onclick="navigateToFolder('')">
                            <i class="fas fa-home"></i> Home
                        </a>
                    </span>
                </div>
                
                <!-- Assets Grid Container -->
                <div class="asset-grid" id="assetsGrid">
                    <!-- Assets will be populated here by JavaScript -->
                </div>
            </div>

            <!-- Settings Section -->
            <div id="settings-section" class="section">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="fas fa-sliders-h"></i> Settings</h2>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-shield-alt"></i> Safety Settings</h5>
                            </div>
                            <div class="card-body">
                                <div class="form-group mb-3">
                                    <label class="form-label">Default Safe Search</label>
                                    <select class="form-select" id="defaultSafeSearch">
                                        <option value="true">Enabled (Hide adult content)</option>
                                        <option value="false">Disabled (Show all content)</option>
                                    </select>
                                </div>
                                <div class="form-group mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="requireAgeVerification" checked>
                                        <label class="form-check-label" for="requireAgeVerification">
                                            Require age verification for adult content
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-download"></i> Download Settings</h5>
                            </div>
                            <div class="card-body">
                                <div class="form-group mb-3">
                                    <label class="form-label">Default Max Items</label>
                                    <input type="number" class="form-control" id="defaultMaxItems" value="25" min="1" max="500">
                                </div>
                                <div class="form-group mb-3">
                                    <label class="form-label">Download Quality</label>
                                    <select class="form-select" id="downloadQuality">
                                        <option value="high">High Quality</option>
                                        <option value="medium" selected>Medium Quality</option>
                                        <option value="low">Low Quality</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Account Settings Section -->
    <div id="account-settings-section" class="section">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="fas fa-user-cog"></i> Account Settings</h2>
            <button class="btn btn-outline-secondary" onclick="showSection('dashboard')">
                <i class="fas fa-arrow-left"></i> Back to Dashboard
            </button>
        </div>
        
        <div class="row">
            <!-- Profile Settings -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-user"></i> Profile Information</h5>
                    </div>
                    <div class="card-body">
                        {% if user_info.authenticated %}
                        <div class="text-center mb-3">
                            <div class="user-avatar-badge" style="width: 80px; height: 80px; font-size: 28px; margin: 0 auto;">
                                {% if user_info.user.picture %}
                                    <img src="{{ user_info.user.picture }}" alt="Profile">
                                {% else %}
                                    {{ user_info.user.name.split()[0][0] }}{{ user_info.user.name.split()[1][0] if user_info.user.name.split()|length > 1 else '' }}
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="form-group mb-3">
                            <label class="form-label">Full Name</label>
                            <input type="text" class="form-control" value="{{ user_info.user.name }}" readonly>
                        </div>
                        
                        <div class="form-group mb-3">
                            <label class="form-label">Email Address</label>
                            <input type="email" class="form-control" value="{{ user_info.user.email }}" readonly>
                        </div>
                        
                        <div class="form-group mb-3">
                            <label class="form-label">Account Type</label>
                            <div class="d-flex gap-1">
                                {% for role in user_info.user.roles %}
                                <span class="badge bg-primary">{{ role.title() }}</span>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <div class="form-group mb-3">
                            <label class="form-label">Member Since</label>
                            <input type="text" class="form-control" value="{{ user_info.user.created_at }}" readonly>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Billing & Subscription -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-credit-card"></i> Billing & Subscription</h5>
                    </div>
                    <div class="card-body">
                        <div class="text-center mb-4">
                            <div class="badge bg-success fs-6 mb-2">Free Tier</div>
                            <p class="text-muted">You're currently using the free tier</p>
                        </div>
                        
                        <div class="card bg-light mb-3">
                            <div class="card-body">
                                <h6 class="card-title">
                                    <i class="fas fa-crown text-warning"></i> 
                                    Upgrade to Pro
                                </h6>
                                <ul class="list-unstyled mb-3">
                                    <li><i class="fas fa-check text-success"></i> Unlimited downloads</li>
                                    <li><i class="fas fa-check text-success"></i> Priority support</li>
                                    <li><i class="fas fa-check text-success"></i> Advanced filters</li>
                                    <li><i class="fas fa-check text-success"></i> Bulk operations</li>
                                </ul>
                                <button class="btn btn-warning w-100" onclick="showBillingInfo()">
                                    <i class="fas fa-rocket"></i> Upgrade for $9.99/month
                                </button>
                            </div>
                        </div>
                        
                        <!-- Payment Method Section -->
                        <div class="form-group mb-3">
                            <label class="form-label">Payment Method</label>
                            <div class="card border-dashed" style="border-style: dashed;">
                                <div class="card-body text-center">
                                    <i class="fas fa-plus-circle text-muted fa-2x mb-2"></i>
                                    <p class="text-muted">No payment method added</p>
                                    <button class="btn btn-outline-primary btn-sm" onclick="addPaymentMethod()">
                                        <i class="fas fa-credit-card"></i> Add Payment Method
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Billing History -->
                        <div class="form-group">
                            <label class="form-label">Billing History</label>
                            <div class="text-center py-3">
                                <i class="fas fa-receipt text-muted fa-2x mb-2"></i>
                                <p class="text-muted">No billing history available</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Usage Statistics -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-bar"></i> Usage Statistics</h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-md-3">
                                <div class="stat-card">
                                    <div class="stat-value" id="userTotalDownloads">0</div>
                                    <div class="stat-label">Total Downloads</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-card">
                                    <div class="stat-value" id="userTotalImages">0</div>
                                    <div class="stat-label">Images Downloaded</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-card">
                                    <div class="stat-value" id="userTotalVideos">0</div>
                                    <div class="stat-label">Videos Downloaded</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-card">
                                    <div class="stat-value" id="userStorageUsed">0 MB</div>
                                    <div class="stat-label">Storage Used</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js">
        // Video autoplay on hover
        document.addEventListener('DOMContentLoaded', function() {
            const assetCards = document.querySelectorAll('.asset-card');
            
            assetCards.forEach(card => {
                const video = card.querySelector('video');
                const thumbnail = card.querySelector('img.video-thumbnail');
                
                if (video && thumbnail) {
                    // Hide video by default
                    video.style.display = 'none';
                    
                    card.addEventListener('mouseenter', function() {
                        thumbnail.style.display = 'none';
                        video.style.display = 'block';
                        video.play().catch(e => console.log('Autoplay prevented:', e));
                    });
                    
                    card.addEventListener('mouseleave', function() {
                        video.pause();
                        video.currentTime = 0;
                        video.style.display = 'none';
                        thumbnail.style.display = 'block';
                    });
                }
            });
        });
        
        // Enhanced keyboard navigation for image viewer
        let currentImageIndex = 0;
        let viewerImages = [];
        
        function openImageViewer(index) {
            currentImageIndex = index;
            const viewer = document.getElementById('imageViewer');
            const img = document.getElementById('viewerImage');
            
            if (viewer && img && viewerImages[index]) {
                img.src = viewerImages[index].src;
                viewer.classList.add('active');
                document.body.style.overflow = 'hidden';
            }
        }
        
        function closeImageViewer() {
            const viewer = document.getElementById('imageViewer');
            if (viewer) {
                viewer.classList.remove('active');
                document.body.style.overflow = '';
            }
        }
        
        function navigateViewer(direction) {
            if (direction === 'next') {
                currentImageIndex = (currentImageIndex + 1) % viewerImages.length;
            } else {
                currentImageIndex = (currentImageIndex - 1 + viewerImages.length) % viewerImages.length;
            }
            openImageViewer(currentImageIndex);
        }
        
        // Keyboard controls
        document.addEventListener('keydown', function(e) {
            const viewer = document.getElementById('imageViewer');
            if (!viewer || !viewer.classList.contains('active')) return;
            
            switch(e.key) {
                case 'ArrowLeft':
                case 'a':
                case 'A':
                    navigateViewer('prev');
                    break;
                case 'ArrowRight':
                case 'd':
                case 'D':
                    navigateViewer('next');
                    break;
                case 'ArrowUp':
                case 'w':
                case 'W':
                    // Zoom in
                    const img = document.getElementById('viewerImage');
                    if (img) {
                        const currentScale = parseFloat(img.style.transform.replace('scale(', '').replace(')', '') || '1');
                        img.style.transform = `scale(${Math.min(currentScale + 0.1, 3)})`;
                    }
                    break;
                case 'ArrowDown':
                case 's':
                case 'S':
                    // Zoom out
                    const img2 = document.getElementById('viewerImage');
                    if (img2) {
                        const currentScale = parseFloat(img2.style.transform.replace('scale(', '').replace(')', '') || '1');
                        img2.style.transform = `scale(${Math.max(currentScale - 0.1, 0.5)})`;
                    }
                    break;
                case 'Escape':
                    closeImageViewer();
                    break;
            }
        });
    
    
        function signOut() {
            if (confirm('Are you sure you want to sign out?')) {
                window.location.href = '/logout';
            }
        }
    
    
        // Fix sign out functionality
        function signOut() {
            if (confirm('Are you sure you want to sign out?')) {
                window.location.href = '/logout';
            }
        }
        
        // Video preview on hover
        function initVideoPreview() {
            document.querySelectorAll('.asset-card').forEach(card => {
                const thumbnail = card.querySelector('img');
                const videoSrc = thumbnail?.dataset.videoSrc;
                
                if (videoSrc && thumbnail) {
                    // Create preview video element
                    const video = document.createElement('video');
                    video.className = 'preview';
                    video.src = videoSrc;
                    video.muted = true;
                    video.loop = true;
                    video.preload = 'metadata';
                    
                    card.appendChild(video);
                    
                    // Play on hover
                    card.addEventListener('mouseenter', () => {
                        video.play().catch(e => console.log('Autoplay prevented'));
                    });
                    
                    card.addEventListener('mouseleave', () => {
                        video.pause();
                        video.currentTime = 0;
                    });
                }
            });
        }
        
        // Initialize on page load and after loading assets
        document.addEventListener('DOMContentLoaded', initVideoPreview);
        
        // Enhanced image viewer with WASD support
        const imageViewer = {
            currentIndex: 0,
            images: [],
            
            init() {
                document.addEventListener('keydown', (e) => {
                    if (!this.isOpen()) return;
                    
                    switch(e.key.toLowerCase()) {
                        case 'arrowleft':
                        case 'a':
                            this.previous();
                            break;
                        case 'arrowright':
                        case 'd':
                            this.next();
                            break;
                        case 'arrowup':
                        case 'w':
                            this.zoomIn();
                            break;
                        case 'arrowdown':
                        case 's':
                            this.zoomOut();
                            break;
                        case 'escape':
                            this.close();
                            break;
                    }
                });
            },
            
            open(index) {
                this.currentIndex = index;
                const viewer = document.getElementById('imageViewer');
                if (viewer) {
                    viewer.classList.add('active');
                    this.updateImage();
                }
            },
            
            close() {
                const viewer = document.getElementById('imageViewer');
                if (viewer) {
                    viewer.classList.remove('active');
                }
            },
            
            isOpen() {
                const viewer = document.getElementById('imageViewer');
                return viewer && viewer.classList.contains('active');
            },
            
            next() {
                this.currentIndex = (this.currentIndex + 1) % this.images.length;
                this.updateImage();
            },
            
            previous() {
                this.currentIndex = (this.currentIndex - 1 + this.images.length) % this.images.length;
                this.updateImage();
            },
            
            updateImage() {
                const img = document.getElementById('viewerImage');
                if (img && this.images[this.currentIndex]) {
                    img.src = this.images[this.currentIndex];
                }
            },
            
            zoomIn() {
                const img = document.getElementById('viewerImage');
                if (img) {
                    const scale = parseFloat(img.style.transform.replace('scale(', '').replace(')', '') || '1');
                    img.style.transform = `scale(${Math.min(scale + 0.1, 3)})`;
                }
            },
            
            zoomOut() {
                const img = document.getElementById('viewerImage');
                if (img) {
                    const scale = parseFloat(img.style.transform.replace('scale(', '').replace(')', '') || '1');
                    img.style.transform = `scale(${Math.max(scale - 0.1, 0.5)})`;
                }
            }
        };
        
        // Initialize image viewer
        imageViewer.init();
    
    </script>
    
    <script>
        /**
         * ============================================================================
         * ENHANCED MEDIA SCRAPER - COMPLETE FUNCTIONALITY DOCUMENTATION
         * ============================================================================
         * 
         * VERSION: 2.0 Pro Enhanced
         * LAST UPDATED: May 30, 2025
         * 
         * ⚠️  CRITICAL WARNING: DO NOT MODIFY THE FOLLOWING WORKING FEATURES ⚠️
         * 
         * ============================================================================
         * ✅ CONFIRMED WORKING FEATURES (DO NOT BREAK):
         * ============================================================================
         * 
         * 🎨 ASSETS VIEWER:
         * ✅ 5-per-row thumbnail grid layout (responsive: 4 on medium, 3 on small screens)
         * ✅ All/Images/Videos filter buttons working correctly
         * ✅ Proper asset counting and section headers
         * ✅ Enhanced video thumbnails with canvas generation
         * ✅ Video hover previews with 500ms delay
         * ✅ Video format badges (MP4, WEBM, OGG, etc.)
         * ✅ Video duration display in MM:SS format
         * ✅ Fallback thumbnails for unsupported videos
         * ✅ Error handling for corrupted media files
         * 
         * 🎮 MEDIA VIEWER (FULLSCREEN):
         * ✅ Arrow key navigation: ← → for previous/next media
         * ✅ Arrow key fullscreen: ↑ for maximize modes, ↓ for minimize/close
         * ✅ Three fullscreen modes: normal → maximize → stretch
         * ✅ Keyboard shortcuts: F=fullscreen, Space=play/pause, ESC=close
         * ✅ Enhanced UI with controls and navigation buttons
         * ✅ Backdrop blur effects and smooth transitions
         * ✅ Video controls with autoplay and loop
         * ✅ Proper cleanup on close (stop videos, reset state)
         * 
         * 🔧 SYSTEM FUNCTIONS:
         * ✅ updateDashboard() function fixed and working
         * ✅ Asset loading and refresh functionality
         * ✅ Source management and safe search toggle
         * ✅ Real-time download progress tracking
         * ✅ Job status monitoring and updates
         * ✅ Error handling and user notifications
         * ✅ Responsive design and mobile compatibility
         * 
         * 🎯 SEARCH & DOWNLOAD:
         * ✅ Multi-source comprehensive search
         * ✅ Adult content filtering with safe search
         * ✅ Real-time progress indicators
         * ✅ Background job processing
         * ✅ Download statistics and reporting
         * ✅ File organization and categorization
         * 
         * ============================================================================
         * 🔧 IMPLEMENTATION NOTES:
         * ============================================================================
         * 
         * CSS GRID LAYOUT:
         * - Uses CSS Grid with `repeat(5, 1fr)` for 5 columns
         * - Responsive breakpoints maintain aspect ratios
         * - DO NOT change grid-template-columns without testing
         * 
         * VIDEO THUMBNAILS:
         * - Canvas-based thumbnail generation from first frame
         * - Multiple fallback systems for compatibility
         * - Preload="metadata" for performance
         * - Error handling prevents UI breakage
         * 
         * KEYBOARD NAVIGATION:
         * - Context-aware: different keys work in different modes
         * - Media viewer vs. asset grid have different handlers
         * - Event prevention and propagation carefully managed
         * 
         * STATE MANAGEMENT:
         * - Global variables track current mode and selections
         * - Proper cleanup prevents memory leaks
         * - Event listeners added/removed appropriately
         * 
         * ============================================================================
         * 🚨 COMMON PITFALLS TO AVOID:
         * ============================================================================
         * 
         * 1. DO NOT change the 500ms video hover delay
         * 2. DO NOT modify the grid CSS without testing all screen sizes
         * 3. DO NOT remove error handling from video functions
         * 4. DO NOT change keyboard event.preventDefault() calls
         * 5. DO NOT modify the fullscreen mode state machine
         * 6. DO NOT remove the canvas thumbnail generation
         * 7. DO NOT change the asset card HTML structure
         * 8. DO NOT modify the media viewer navigation logic
         * 
         * ============================================================================
         * 📝 TESTING CHECKLIST (VERIFY AFTER ANY CHANGES):
         * ============================================================================
         * 
         * □ Thumbnails display in 5-per-row grid
         * □ Filter buttons (All/Images/Videos) work
         * □ Video hover previews start after 500ms
         * □ Video thumbnails generate from first frame
         * □ Media viewer opens on click
         * □ Arrow keys navigate media (←→)
         * □ Arrow keys control fullscreen (↑↓)
         * □ F key toggles fullscreen
         * □ Space key plays/pauses videos
         * □ ESC key closes media viewer
         * □ Videos display duration in MM:SS
         * □ Asset counts update correctly
         * □ Error handling works for broken files
         * □ Responsive design works on mobile
         * 
         * ============================================================================
         */

        // Global State Variables
        let currentJobId = null;
        let progressUpdateInterval = null;
        let selectedAssets = new Set();
        let currentAssets = [];
        let sources = {};
        let adultWarningShown = false;
        let currentContainer = 'default';

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Enhanced Media Scraper initializing...');
            
            // Add a small delay to ensure all elements are ready
            setTimeout(() => {
                initializeApp();
            }, 100);
        });

        async function initializeApp() {
            try {
                console.log('📋 Starting application initialization...');
                
                // Load user subscription info
                try {
                    await loadUserSubscriptionInfo();
                    console.log('✅ Subscription info loaded');
                } catch (error) {
                    console.error('❌ Error loading subscription info:', error);
                }
                
                // Verify critical elements exist
                const criticalElements = [
                    'dashboard-section',
                    'search-section', 
                    'assets-section',
                    'sources-section'
                ];
                
                const missingElements = criticalElements.filter(id => !document.getElementById(id));
                if (missingElements.length > 0) {
                    console.warn('⚠️ Missing elements:', missingElements);
                }
                
                // Initialize with error handling for each step
                try {
                    showSection('dashboard');
                    console.log('✅ Dashboard section shown');
                } catch (error) {
                    console.error('❌ Error showing dashboard:', error);
                }
                
                try {
                    await loadSources();
                    console.log('✅ Sources loaded');
                } catch (error) {
                    console.error('❌ Error loading sources:', error);
                }
                
                try {
                    await loadAssets();
                    console.log('✅ Assets loaded');
                } catch (error) {
                    console.error('❌ Error loading assets:', error);
                }
                
                try {
                    updateDashboard();
                    console.log('✅ Dashboard updated');
                } catch (error) {
                    console.error('❌ Error updating dashboard:', error);
                }
                
                // Setup safe search toggles (both search page and sources page)
                try {
                    setupSafeSearchToggle();
                    console.log('✅ Safe search toggle setup');
                } catch (error) {
                    console.error('❌ Error setting up safe search toggle:', error);
                }
                
                try {
                    setupSourcesPageToggle();
                    console.log('✅ Sources page toggle setup');
                } catch (error) {
                    console.error('❌ Error setting up sources page toggle:', error);
                }
                
                // Setup search form
                try {
                    setupSearchForm();
                    console.log('✅ Search form setup');
                } catch (error) {
                    console.error('❌ Error setting up search form:', error);
                }
                
                console.log('✅ Application initialized successfully');
                
                // Test basic functionality
                console.log('🧪 Testing basic functionality...');
                if (typeof showSection === 'function') {
                    console.log('✅ showSection function available');
                } else {
                    console.error('❌ showSection function not available');
                }
                
            } catch (error) {
                console.error('❌ Initialization error:', error);
                showError('Failed to initialize application: ' + error.message);
                
                // Try to show a basic error message even if showError fails
                try {
                    const errorDiv = document.createElement('div');
                    errorDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #f44336; color: white; padding: 15px; border-radius: 5px; z-index: 9999;';
                    errorDiv.textContent = 'Application initialization failed. Please refresh the page.';
                    document.body.appendChild(errorDiv);
                } catch (e) {
                    console.error('❌ Could not show error message:', e);
                }
            }
        }

        // Navigation Functions
        function showSection(sectionName) {
            try {
                console.log(`🔄 Switching to section: ${sectionName}`);
                
                // Hide all sections
                const sections = document.querySelectorAll('.section');
                if (sections.length === 0) {
                    console.warn('⚠️ No sections found with .section class');
                }
                sections.forEach(section => section.style.display = 'none');
                
                // Show selected section
                const targetSection = document.getElementById(sectionName + '-section');
                if (targetSection) {
                    targetSection.style.display = 'block';
                    console.log(`✅ Section ${sectionName} displayed`);
                } else {
                    console.error(`❌ Section element not found: ${sectionName}-section`);
                    return;
                }
                
                // Update active nav item
                const navItems = document.querySelectorAll('.nav-item');
                if (navItems.length === 0) {
                    console.warn('⚠️ No navigation items found with .nav-item class');
                }
                navItems.forEach(item => item.classList.remove('active'));
                
                // Find and activate current nav item
                const activeNavItem = Array.from(navItems).find(item => 
                    item.getAttribute('onclick') && item.getAttribute('onclick').includes(sectionName)
                );
                if (activeNavItem) {
                    activeNavItem.classList.add('active');
                    console.log(`✅ Navigation item activated for ${sectionName}`);
                } else {
                    console.warn(`⚠️ Navigation item not found for section: ${sectionName}`);
                }
                
                // Load section-specific data
                switch(sectionName) {
                    case 'search':
                        try {
                            loadSources();
                            updateDashboard();
                        } catch (error) {
                            console.error('❌ Error loading search section data:', error);
                        }
                        break;
                    case 'assets':
                        try {
                            loadAssets();
                        } catch (error) {
                            console.error('❌ Error loading assets section data:', error);
                        }
                        break;
                    case 'sources':
                        try {
                            loadSourcesPage();
                        } catch (error) {
                            console.error('❌ Error loading sources section data:', error);
                        }
                        break;
                    default:
                        console.log(`ℹ️ No specific data loading for section: ${sectionName}`);
                }
                
            } catch (error) {
                console.error(`❌ Error in showSection(${sectionName}):`, error);
                
                // Try to show an error message
                try {
                    showError(`Failed to switch to ${sectionName} section: ${error.message}`);
                } catch (e) {
                    console.error('❌ Could not show error message:', e);
                }
            }
        }

        // Dashboard Functions
        function updateDashboard() {
            // Update system status and statistics
            console.log('📊 Dashboard updated');
            
            // Update source count if element exists
            const totalSourcesElement = document.getElementById('totalSources');
            if (totalSourcesElement && sources) {
                const totalSources = Object.values(sources).reduce((sum, category) => sum + category.length, 0);
                totalSourcesElement.textContent = totalSources;
            }
            
            // Update assets count if element exists  
            if (currentAssets && currentAssets.length > 0) {
                updateAssetCounts();
            }
            
            // Update other dashboard elements as needed
            const timestamp = new Date().toLocaleString();
            console.log(`📈 Dashboard last updated: ${timestamp}`);
        }

        function refreshAssets() {
            console.log('🔄 Refreshing assets...');
            loadAssets();
        }

        function refreshSources() {
            console.log('🔄 Refreshing sources...');
            loadSources();
        }

        function loadSourcesPage() {
            // Load sources for the dedicated sources page
            loadSources();
        }

        // Enhanced click handler for asset navigation
        function navigateAssetByClick(assetIndex) {
            // Use global currentAssets array instead of passed list
            openMediaViewer(assetIndex, currentAssets);
        }

        // Legacy function compatibility - redirect to new function
        function showMediaViewer(index, mediaList) {
            openMediaViewer(index, mediaList);
        }

        // Sources Page Functions
        function setupSourcesPageToggle() {
            const sourcesPageToggle = document.getElementById('sourcesPageSafeSearchToggle');
            const mainToggle = document.getElementById('safeSearchToggle');
            
            if (sourcesPageToggle && mainToggle) {
                // Sync toggles
                sourcesPageToggle.checked = mainToggle.checked;
                
                sourcesPageToggle.addEventListener('change', function() {
                    const isEnabled = this.checked;
                    
                    if (!isEnabled && !adultWarningShown) {
                        showAdultContentWarning(() => {
                            adultWarningShown = true;
                            mainToggle.checked = false;
                            updateSafeSearchStatus(false);
                            updateSourcesPageSafeSearchStatus(false);
                            loadSourcesPage();
                        }, () => {
                            // User cancelled, keep safe search on
                            this.checked = true;
                        });
                    } else {
                        // Sync with main toggle
                        mainToggle.checked = isEnabled;
                        updateSafeSearchStatus(isEnabled);
                        updateSourcesPageSafeSearchStatus(isEnabled);
                        loadSourcesPage();
                    }
                });
            }
        }

        function updateSourcesPageSafeSearchStatus(enabled) {
            const sourcesPageStatus = document.getElementById('sourcesPageSafeSearchStatus');
            if (sourcesPageStatus) {
                sourcesPageStatus.textContent = enabled ? 'ON' : 'OFF';
                sourcesPageStatus.style.color = enabled ? '#4CAF50' : '#FF5722';
                
                if (enabled) {
                    sourcesPageStatus.classList.remove('off');
                } else {
                    sourcesPageStatus.classList.add('off');
                }
            }

            // Show/hide adult content warning
            const adultWarning = document.getElementById('adultContentWarning');
            if (adultWarning) {
                adultWarning.style.display = enabled ? 'none' : 'block';
            }
        }

        async function loadSourcesPage() {
            try {
                const safeSearch = document.getElementById('sourcesPageSafeSearchToggle').checked;
                const response = await fetch(`/api/sources?safe_search=${safeSearch}`);
                const data = await response.json();
                
                if (data.success) {
                    sources = data.sources;
                    updateSourcesPageDisplay(safeSearch);
                    updateSourcesPageStats();
                    console.log('📦 Sources page loaded:', Object.keys(sources).length, 'categories');
                } else {
                    throw new Error(data.error || 'Failed to load sources');
                }
            } catch (error) {
                console.error('❌ Error loading sources page:', error);
                showError('Failed to load sources: ' + error.message);
            }
        }

        function updateSourcesPageDisplay(safeSearchEnabled = true) {
            const categoriesContainer = document.getElementById('sourcesPageCategories');
            if (!categoriesContainer) return;

            categoriesContainer.innerHTML = '';

            // Define category mappings
            const categoryMappings = {
                social: { name: 'Social Media', icon: 'fab fa-facebook', color: '#3b5998' },
                video: { name: 'Video Platforms', icon: 'fas fa-video', color: '#ff0000' },
                search: { name: 'Search Engines', icon: 'fas fa-search', color: '#4285f4' },
                art: { name: 'Art & Creative', icon: 'fas fa-paint-brush', color: '#e91e63' },
                gallery: { name: 'Image Galleries', icon: 'fas fa-images', color: '#ff9800' },
                stock: { name: 'Stock Photos', icon: 'fas fa-camera', color: '#00bcd4' },
                news: { name: 'News & Media', icon: 'fas fa-newspaper', color: '#607d8b' },
                direct: { name: 'Direct Sources', icon: 'fas fa-link', color: '#795548' },
                adult: { name: 'Adult Content (18+)', icon: 'fas fa-exclamation-triangle', color: '#f44336' }
            };

            // Create the main table container
            const tableContainer = document.createElement('div');
            tableContainer.className = 'sources-table-container';
            
            // Create the table
            const table = document.createElement('table');
            table.className = 'sources-table';
            
            // Create table header
            const thead = document.createElement('thead');
            thead.innerHTML = `
                <tr>
                    <th class="checkbox-col">
                        <input type="checkbox" class="source-table-checkbox" id="selectAllSourcesTable" 
                               onchange="toggleAllSourcesInTable(this.checked)">
                    </th>
                    <th class="icon-col">Type</th>
                    <th class="name-col">Source Name</th>
                    <th class="category-col">Category</th>
                    <th class="status-col">Status</th>
                </tr>
            `;
            table.appendChild(thead);
            
            // Create table body
            const tbody = document.createElement('tbody');
            
            // Flatten all sources into rows
            Object.entries(categoryMappings).forEach(([categoryKey, categoryInfo]) => {
                const categorySources = sources[categoryKey] || [];
                
                // Skip adult category if safe search is enabled
                if (categoryKey === 'adult' && safeSearchEnabled) {
                    return;
                }
                
                // Add category header row if there are sources
                if (categorySources.length > 0) {
                    const categoryHeaderRow = document.createElement('tr');
                    categoryHeaderRow.innerHTML = `
                        <td colspan="5" class="category-section-header">
                            <div>
                                <i class="${categoryInfo.icon}" style="color: ${categoryInfo.color}"></i>
                                ${categoryInfo.name} (${categorySources.length} sources)
                            </div>
                            <div class="category-controls">
                                <button class="btn btn-sm btn-outline-success" onclick="enableCategorySources('${categoryKey}')">
                                    <i class="fas fa-check"></i> Enable All
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="disableCategorySources('${categoryKey}')">
                                    <i class="fas fa-times"></i> Disable All
                                </button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(categoryHeaderRow);
                    
                    // Add source rows
                    categorySources.forEach(source => {
                        const row = document.createElement('tr');
                        const isLocked = source.locked || false;
                        const lockReason = source.lock_reason || 'Subscribe to unlock';
                        
                        row.innerHTML = `
                            <td class="checkbox-col">
                                <input type="checkbox" class="source-table-checkbox sources-page-checkbox" 
                                       id="sources-page-${source.name}" 
                                       value="${source.name}" 
                                       data-category="${categoryKey}"
                                       ${source.enabled ? 'checked' : ''}
                                       ${isLocked ? 'disabled' : ''}>
                            </td>
                            <td class="icon-col">
                                <div class="source-icon ${categoryKey}">
                                    <i class="${categoryInfo.icon}"></i>
                                </div>
                            </td>
                            <td class="name-col">
                                ${source.display_name}
                                ${isLocked ? `<i class="fas fa-lock ms-2" title="${lockReason}"></i>` : ''}
                            </td>
                            <td class="category-col">
                                <span class="category-badge">
                                    <i class="${categoryInfo.icon}"></i>
                                    ${categoryInfo.name}
                                </span>
                            </td>
                            <td class="status-col">
                                ${isLocked ? 
                                    `<span class="source-status locked">
                                        <i class="fas fa-lock"></i> Locked
                                    </span>` :
                                    `<span class="source-status enabled">
                                        <i class="fas fa-check-circle"></i> Available
                                    </span>`
                                }
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                }
            });
            
            table.appendChild(tbody);
            tableContainer.appendChild(table);
            categoriesContainer.appendChild(tableContainer);

            // Add event listeners
            document.querySelectorAll('.sources-page-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', updateSourcesPageStats);
            });
        }
        
        function toggleAllSourcesInTable(checked) {
            document.querySelectorAll('.sources-page-checkbox:not(:disabled)').forEach(checkbox => {
                checkbox.checked = checked;
            });
            updateSourcesPageStats();
        }

        function updateSourcesPageStats() {
            const totalSources = document.querySelectorAll('.sources-page-checkbox').length;
            const enabledSources = document.querySelectorAll('.sources-page-checkbox:checked').length;
            const adultSources = document.querySelectorAll('.sources-page-checkbox[data-category="adult"]').length;
            const categories = Object.keys(sources).length;

            document.getElementById('totalSourcesCount').textContent = totalSources;
            document.getElementById('enabledSourcesCount').textContent = enabledSources;
            document.getElementById('adultSourcesCount').textContent = adultSources;
            document.getElementById('categoriesCount').textContent = categories;
        }

        function enableAllSources() {
            document.querySelectorAll('.sources-page-checkbox').forEach(checkbox => {
                checkbox.checked = true;
            });
            updateSourcesPageStats();
            showSuccess('All sources enabled');
        }

        function disableAllSources() {
            document.querySelectorAll('.sources-page-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
            updateSourcesPageStats();
            showSuccess('All sources disabled');
        }

        function enableCategorySources(category) {
            document.querySelectorAll(`.sources-page-checkbox[data-category="${category}"]`).forEach(checkbox => {
                checkbox.checked = true;
            });
            updateSourcesPageStats();
            
            const categoryNames = {
                social: 'Social Media',
                video: 'Video Platforms',
                search: 'Search Engines',
                art: 'Art & Creative',
                gallery: 'Image Galleries',
                stock: 'Stock Photos',
                news: 'News & Media',
                direct: 'Direct Sources',
                adult: 'Adult Content'
            };
            
            showSuccess(`${categoryNames[category]} sources enabled`);
        }

        function disableCategorySources(category) {
            document.querySelectorAll(`.sources-page-checkbox[data-category="${category}"]`).forEach(checkbox => {
                checkbox.checked = false;
            });
            updateSourcesPageStats();
            
            const categoryNames = {
                social: 'Social Media',
                video: 'Video Platforms',
                search: 'Search Engines',
                art: 'Art & Creative',
                gallery: 'Image Galleries',
                stock: 'Stock Photos',
                news: 'News & Media',
                direct: 'Direct Sources',
                adult: 'Adult Content'
            };
            
            showSuccess(`${categoryNames[category]} sources disabled`);
        }

        function updateSourceCount() {
            const checkboxes = document.querySelectorAll('.source-checkbox:checked');
            const count = checkboxes.length;
            const totalCheckboxes = document.querySelectorAll('.source-checkbox');
            const total = totalCheckboxes.length;
            
            const sourceCountElement = document.getElementById('sourceCount');
            if (sourceCountElement) {
                sourceCountElement.textContent = `(${count}/${total} selected)`;
            }
        }

        function setupSafeSearchToggle() {
            const safeSearchToggle = document.getElementById('safeSearchToggle');
            const safeSearchStatus = document.getElementById('safeSearchStatus');
            
            if (safeSearchToggle && safeSearchStatus) {
                safeSearchToggle.addEventListener('change', function() {
                    const isEnabled = this.checked;
                    
                    if (!isEnabled && !adultWarningShown) {
                        showAdultContentWarning(() => {
                            adultWarningShown = true;
                            updateSafeSearchStatus(false);
                            loadSources(); // Reload sources to show adult content
                        }, () => {
                            // User cancelled, keep safe search on
                            this.checked = true;
                        });
                    } else {
                        updateSafeSearchStatus(isEnabled);
                        loadSources(); // Reload sources
                    }
                });
                
                // Initialize with safe search on
                updateSafeSearchStatus(true);
            }
        }

        function updateSafeSearchStatus(enabled) {
            const safeSearchStatus = document.getElementById('safeSearchStatus');
            if (safeSearchStatus) {
                safeSearchStatus.textContent = enabled ? 
                    'ON (Adult content hidden)' : 
                    'OFF (Adult content available)';
                
                // Update styling
                if (enabled) {
                    safeSearchStatus.classList.remove('off');
                    safeSearchStatus.style.color = '#4CAF50';
                } else {
                    safeSearchStatus.classList.add('off');
                    safeSearchStatus.style.color = '#FF5722';
                }
            }
        }

        function showAdultContentWarning(onConfirm, onCancel) {
            const confirmed = confirm(
                '⚠️ AGE VERIFICATION REQUIRED\n\n' +
                'You are about to enable adult content sources.\n\n' +
                '• You must be 18+ years old\n' +
                '• Adult content will be available for download\n' +
                '• This content may not be suitable for all users\n\n' +
                'Do you confirm that you are 18+ and wish to proceed?'
            );
            
            if (confirmed) {
                onConfirm();
            } else {
                onCancel();
            }
        }

        function toggleAllSources(enable) {
            const checkboxes = document.querySelectorAll('.source-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = enable;
            });
            updateSourceCount();
        }

        async function refreshSources() {
            try {
                await loadSources();
                showSuccess('Sources refreshed successfully');
            } catch (error) {
                showError('Failed to refresh sources: ' + error.message);
            }
        }

        // Search Form Setup
        function setupSearchForm() {
            const searchForm = document.getElementById('searchForm');
            if (searchForm) {
                searchForm.addEventListener('submit', handleSearch);
            }
            
            // Add event listeners for source count updates
            document.addEventListener('change', function(e) {
                if (e.target.classList.contains('source-checkbox')) {
                    updateSourceCount();
                }
            });
        }

        async function handleSearch(event) {
            event.preventDefault();
            
            const query = document.getElementById('searchQuery').value.trim();
            const searchType = document.getElementById('searchType').value;
            const maxItems = parseInt(document.getElementById('maxItems').value) || 25;
            const safeSearch = document.getElementById('safeSearchToggle').checked;
            
            if (!query) {
                showError('Please enter a search query');
                return;
            }
            
            // Get enabled sources
            const enabledSources = Array.from(document.querySelectorAll('.source-checkbox:checked'))
                .map(checkbox => checkbox.value);
            
            if (enabledSources.length === 0) {
                showError('Please select at least one content source');
                return;
            }
            
            try {
                await startSearch({
                    query,
                    searchType,
                    maxContent: maxItems,
                    enabledSources,
                    safeSearch
                });
            } catch (error) {
                showError('Search failed: ' + error.message);
            }
        }

        async function startSearch(params) {
            try {
                showProgressPanel();
                updateProgress('Initializing search...', 0, 0, 0, 0);
                
                const response = await fetch('/api/comprehensive-search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        query: params.query,
                        search_type: params.searchType,
                        max_content: params.maxContent,
                        enabled_sources: params.enabledSources,
                        safe_search: params.safeSearch
                    })
                });
                
                const data = await response.json();
                
                if (response.status === 402) {
                    // Payment required - no credits
                    hideProgressPanel();
                    showError(data.error || 'Upgrade required to continue');
                    if (data.upgrade_required) {
                        setTimeout(() => {
                            window.location.href = '/subscription/plans';
                        }, 2000);
                    }
                    return;
                }
                
                if (data.success) {
                    currentJobId = data.job_id;
                    showSuccess(`Search started! Job ID: ${currentJobId}`);
                    
                    // Update credits display if available
                    if (data.credits_remaining !== undefined) {
                        updateCreditsDisplay(data.credits_remaining);
                        
                        // Update subscription status in navbar
                        if (userSubscriptionInfo && userSubscriptionInfo.subscription) {
                            userSubscriptionInfo.subscription.credits = data.credits_remaining;
                            updateSubscriptionUI(userSubscriptionInfo);
                        }
                    }
                    
                    startProgressUpdates(currentJobId);
                } else {
                    throw new Error(data.error || 'Search failed');
                }
            } catch (error) {
                hideProgressPanel();
                throw error;
            }
        }

        // Progress Management
        function showProgressPanel() {
            const progressPanel = document.getElementById('progressPanel');
            if (progressPanel) {
                progressPanel.style.display = 'block';
                progressPanel.scrollIntoView({ behavior: 'smooth' });
            }
        }

        function hideProgressPanel() {
            const progressPanel = document.getElementById('progressPanel');
            if (progressPanel) {
                progressPanel.style.display = 'none';
            }
        }

        function updateProgress(message, progress, total, downloaded, totalDownloads) {
            const progressBar = document.getElementById('progressBar');
            const progressPercentage = document.getElementById('progressPercentage');
            const progressMessage = document.getElementById('progressMessage');
            const downloadedCount = document.getElementById('downloadedCount');
            const totalDownloadsCount = document.getElementById('totalDownloadsCount');

            if (progressBar) {
                progressBar.style.width = `${progress}%`;
                progressBar.setAttribute('aria-valuenow', progress);
            }
            if (progressPercentage) {
                progressPercentage.textContent = `${progress}%`;
            }
            if (progressMessage) {
                progressMessage.textContent = message;
            }
            if (downloadedCount) {
                downloadedCount.textContent = downloaded;
            }
            if (totalDownloadsCount) {
                totalDownloadsCount.textContent = totalDownloads;
            }
        }

        function showSuccess(message) {
            showAlert('success', message);
        }

        function showError(message) {
            showAlert('danger', message);
        }

        function showAlert(type, message) {
            const alertContainer = document.getElementById('alertContainer');
            if (alertContainer) {
                alertContainer.innerHTML = `
                    <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                        ${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                `;
            }
        }

        function updateCreditsDisplay(credits) {
            const creditsDisplay = document.getElementById('creditsDisplay');
            if (creditsDisplay) {
                creditsDisplay.innerHTML = `
                    <i class="fas fa-coins"></i>
                    <span class="credits-count">${credits}</span>
                `;
            }
        }
        
        // Start Progress Updates
        function startProgressUpdates(jobId) {
            if (progressUpdateInterval) {
                clearInterval(progressUpdateInterval);
            }
            
            progressUpdateInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/api/job-status/${jobId}`);
                    const data = await response.json();
                    
                    if (data.success) {
                        updateProgress(
                            data.status.message,
                            data.status.progress,
                            data.status.total,
                            data.status.downloaded,
                            data.status.total_downloads
                        );
                        
                        if (data.status.completed) {
                            clearInterval(progressUpdateInterval);
                            progressUpdateInterval = null;
                            showSuccess('Download completed!');
                            
                            // Refresh assets
                            if (typeof loadAssets === 'function') {
                                loadAssets();
                            }
                            
                            // Hide progress panel after a delay
                            setTimeout(() => {
                                hideProgressPanel();
                            }, 3000);
                        }
                    }
                } catch (error) {
                    console.error('Error checking job status:', error);
                }
            }, 1000);
        }
    </script>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
