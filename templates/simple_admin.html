<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Enhanced Media Scraper</title>
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background: #1a1a1a; color: #fff; }
        .admin-card { background: #2d2d2d; border: 1px solid #444; }
        .stat-card { background: #333; border-left: 4px solid #007bff; }
        .nuclear-card { background: #2d1b1b; border: 1px solid #dc3545; }
        .nuclear-btn { background: #dc3545; border: none; color: white; }
        .nuclear-btn:hover { background: #c82333; color: white; }
        .user-row:hover { background: #333; }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-dark">
        <div class="container">
            <span class="navbar-brand">
                <i class="fas fa-users-cog"></i> Admin Dashboard
            </span>
            <div>
                <a href="{{ url_for('index') }}" class="btn btn-outline-light btn-sm">
                    <i class="fas fa-home"></i> Back to App
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Stats Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card stat-card text-white">
                    <div class="card-body">
                        <h4>{{ stats.total_users }}</h4>
                        <p>Total Users</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card text-white">
                    <div class="card-body">
                        <h4>{{ stats.total_assets }}</h4>
                        <p>Total Assets</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card text-white">
                    <div class="card-body">
                        <h4>{{ stats.total_jobs }}</h4>
                        <p>Total Jobs</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card text-white">
                    <div class="card-body">
                        <h4>{{ stats.total_blobs }}</h4>
                        <p>Media Blobs</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Nuclear Admin Tools -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card nuclear-card text-white">
                    <div class="card-header bg-danger">
                        <h5><i class="fas fa-exclamation-triangle"></i> Nuclear Options</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-warning">‚ö†Ô∏è These actions are irreversible!</p>
                        <div class="d-grid gap-2">
                            <button class="btn nuclear-btn" onclick="confirmNuclearAction('all-assets')">
                                <i class="fas fa-bomb"></i> Delete ALL Assets
                            </button>
                            <button class="btn btn-warning" onclick="refreshStats()">
                                <i class="fas fa-sync"></i> Refresh Stats
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card admin-card text-white">
                    <div class="card-header">
                        <h5><i class="fas fa-tools"></i> Quick Actions</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button class="btn btn-info" onclick="loadUsers()">
                                <i class="fas fa-users"></i> View All Users
                            </button>
                            <button class="btn btn-secondary" onclick="showAdvancedOptions()">
                                <i class="fas fa-cogs"></i> Advanced Options
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- User Management -->
        <div class="card admin-card text-white">
            <div class="card-header">
                <h5><i class="fas fa-users"></i> User Management</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <button class="btn btn-outline-info btn-sm" onclick="loadAssetStats()">
                        <i class="fas fa-chart-bar"></i> Load Asset Stats
                    </button>
                    <span id="assets-stats-summary" class="ms-2 text-muted"></span>
                </div>
                <div class="table-responsive">
                    <table class="table table-dark table-striped">
                        <thead>
                            <tr>
                                <th>Email</th>
                                <th>Name</th>
                                <th>Credits</th>
                                <th>Plan</th>
                                <th>Assets</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body">
                            {% for item in users %}
                            <tr class="user-row">
                                <td>
                                    {{ item.user.email }}
                                    {% if item.user.email == 'sop1973@gmail.com' %}
                                        <span class="badge bg-warning">ADMIN</span>
                                    {% endif %}
                                </td>
                                <td>{{ item.user.name or 'N/A' }}</td>
                                <td>
                                    <span class="badge bg-primary">{{ item.user.credits }}</span>
                                    <button class="btn btn-sm btn-outline-success ms-1" 
                                            onclick="resetCredits({{ item.user.id }}, '{{ item.user.email }}')">
                                        <i class="fas fa-coins"></i>
                                    </button>
                                </td>
                                <td>
                                    <span class="badge bg-secondary">{{ item.user.subscription_plan or 'trial' }}</span>
                                </td>
                                <td>{{ item.asset_count }}</td>
                                <td>
                                    <small>{{ item.user.created_at.strftime('%Y-%m-%d') if item.user.created_at else 'Unknown' }}</small>
                                </td>
                                <td>
                                    {% if item.user.email != 'sop1973@gmail.com' %}
                                    <button class="btn btn-sm btn-outline-danger" 
                                            onclick="deleteUserData({{ item.user.id }}, '{{ item.user.email }}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-light ms-1" 
                                            onclick="viewUserAssets({{ item.user.id }}, '{{ item.user.email }}')">
                                        <i class="fas fa-images"></i>
                                    </button>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Advanced Options Modal -->
        <div class="modal fade" id="advancedModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content bg-dark text-white">
                    <div class="modal-header">
                        <h5 class="modal-title">Advanced Admin Options</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="d-grid gap-2">
                            <button class="btn btn-info" onclick="window.open('/admin-test', '_blank')">
                                <i class="fas fa-bug"></i> Debug Test Page
                            </button>
                            <button class="btn btn-warning" onclick="clearBrowserCache()">
                                <i class="fas fa-broom"></i> Clear Browser Cache
                            </button>
                            <button class="btn btn-secondary" onclick="downloadLogs()">
                                <i class="fas fa-download"></i> Download Logs
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- User Assets Modal -->
        <div class="modal fade" id="userAssetsModal" tabindex="-1">
            <div class="modal-dialog modal-xl">
                <div class="modal-content bg-dark text-white">
                    <div class="modal-header">
                        <h5 class="modal-title"><i class="fas fa-images"></i> Assets for <span id="ua-email"></span></h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div><span id="ua-count">0</span> assets</div>
                            <div>
                                <button class="btn btn-sm btn-outline-danger" onclick="bulkDeleteSelectedUserAssets()">
                                    <i class="fas fa-trash"></i> Delete Selected
                                </button>
                            </div>
                        </div>
                        <div class="table-responsive" style="max-height: 60vh; overflow:auto;">
                            <table class="table table-dark table-hover align-middle">
                                <thead style="position: sticky; top: 0; background: #222;">
                                    <tr>
                                        <th style="width:34px;"><input type="checkbox" id="ua-select-all"></th>
                                        <th>Filename</th>
                                        <th>Type</th>
                                        <th>Size</th>
                                        <th>Source</th>
                                        <th>Downloaded</th>
                                    </tr>
                                </thead>
                                <tbody id="ua-tbody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function confirmNuclearAction(action) {
            if (action === 'all-assets') {
                if (confirm('‚ö†Ô∏è This will delete ALL assets for ALL users. Are you absolutely sure?')) {
                    if (confirm('üö® FINAL WARNING: This action cannot be undone! Click OK to proceed with deleting ALL assets.')) {
                        nuclearDeleteAllAssets();
                    }
                }
            }
        }

        async function nuclearDeleteAllAssets() {
            try {
                console.log('üî• Starting nuclear delete all assets...');
                
                // Get CSRF token
                const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
                console.log('üîê CSRF Token:', csrfToken ? 'Found' : 'Missing');
                
                const response = await fetch('/admin/api/nuclear/delete-all-assets', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'X-CSRFToken': csrfToken
                    }
                });
                
                console.log('üì° Response status:', response.status, response.statusText);
                
                if (!response.ok) {
                    const text = await response.text();
                    console.error('‚ùå Response not OK:', response.status, text);
                    alert(`‚ùå Server Error (${response.status}): ${text.substring(0, 200)}...`);
                    return;
                }
                
                const contentType = response.headers.get('content-type');
                console.log('üìã Content-Type:', contentType);
                
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('‚ùå Not JSON response:', text);
                    alert(`‚ùå Server returned HTML instead of JSON. This may be an authentication issue. Response: ${text.substring(0, 200)}...`);
                    return;
                }
                
                const result = await response.json();
                console.log('‚úÖ JSON result:', result);
                
                if (result.success) {
                    alert('‚úÖ ' + result.message);
                    refreshStats();
                } else {
                    alert('‚ùå Error: ' + result.error);
                }
            } catch (error) {
                console.error('‚ùå Exception in nuclearDeleteAllAssets:', error);
                alert('‚ùå Failed: ' + error.message);
            }
        }

        async function deleteUserData(userId, userEmail) {
            if (confirm(`Delete ALL data for ${userEmail}? This cannot be undone.`)) {
                try {
                    // Get CSRF token
                    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
                    
                    const response = await fetch(`/admin/api/nuclear/delete-user-data/${userId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json',
                            'X-CSRFToken': csrfToken
                        }
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        alert('‚úÖ ' + result.message);
                        location.reload();
                    } else {
                        alert('‚ùå Error: ' + result.error);
                    }
                } catch (error) {
                    alert('‚ùå Failed: ' + error.message);
                }
            }
        }

        async function resetCredits(userId, userEmail) {
            const credits = prompt(`Set credits for ${userEmail}:`, '50');
            if (credits && !isNaN(credits)) {
                try {
                    // Get CSRF token
                    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
                    
                    const response = await fetch(`/admin/api/reset-user-credits/${userId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json',
                            'X-CSRFToken': csrfToken
                        },
                        body: JSON.stringify({credits: parseInt(credits)})
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        alert('‚úÖ ' + result.message);
                        location.reload();
                    } else {
                        alert('‚ùå Error: ' + result.error);
                    }
                } catch (error) {
                    alert('‚ùå Failed: ' + error.message);
                }
            }
        }

        async function refreshStats() {
            try {
                const response = await fetch('/admin/api/stats');
                const result = await response.json();
                if (result.success) {
                    location.reload();
                } else {
                    alert('Error refreshing stats: ' + result.error);
                }
            } catch (error) {
                alert('Failed to refresh: ' + error.message);
            }
        }

        function loadUsers() {
            // Already shown in table, could expand this
            alert('Users are displayed in the table below.');
        }

        function showAdvancedOptions() {
            const modal = new bootstrap.Modal(document.getElementById('advancedModal'));
            modal.show();
        }

        function clearBrowserCache() {
            localStorage.clear();
            sessionStorage.clear();
            alert('Browser cache cleared. Please refresh the page.');
        }

        function downloadLogs() {
            // Could implement log download
            alert('Log download feature not yet implemented.');
        }

        // Auto-refresh stats every 30 seconds
        setInterval(async () => {
            try {
                const response = await fetch('/admin/api/stats');
                const result = await response.json();
                if (result.success) {
                    // Update stats without full page reload
                    console.log('Stats updated:', result.stats);
                }
            } catch (error) {
                console.warn('Auto-refresh failed:', error);
            }
        }, 30000);

        async function loadAssetStats() {
            try {
                const r = await fetch('/admin/api/assets/stats');
                const j = await r.json();
                if (j.success) {
                    const s = j.counts;
                    document.getElementById('assets-stats-summary').textContent = `Total: ${s.total} (images: ${s.images}, videos: ${s.videos})`;
                }
            } catch (e) { console.error(e); }
        }

        let UA_SELECTED = new Set();
        let UA_MODAL;
        async function viewUserAssets(userId, email) {
            document.getElementById('ua-email').textContent = email;
            UA_SELECTED.clear();
            const tbody = document.getElementById('ua-tbody');
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Loading...</td></tr>';
            try {
                const r = await fetch(`/admin/api/user/${userId}/assets?limit=500`);
                const j = await r.json();
                if (!j.success) throw new Error(j.error || 'Failed');
                document.getElementById('ua-count').textContent = j.total;
                tbody.innerHTML = '';
                j.assets.forEach(a => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td><input type=\"checkbox\" data-id=\"${a.id}\"></td>
                        <td>${a.filename}</td>
                        <td>${a.file_type}</td>
                        <td>${(a.file_size||0)}</td>
                        <td>${a.source_name||''}</td>
                        <td>${a.downloaded_at||''}</td>
                    `;
                    tbody.appendChild(tr);
                });
                // Wire selection
                tbody.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                    cb.addEventListener('change', (e) => {
                        const id = parseInt(e.target.getAttribute('data-id'));
                        if (e.target.checked) UA_SELECTED.add(id); else UA_SELECTED.delete(id);
                    });
                });
                // Select all
                const sa = document.getElementById('ua-select-all');
                sa.checked = false;
                sa.onchange = (e) => {
                    const checked = e.target.checked;
                    tbody.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                        cb.checked = checked;
                        const id = parseInt(cb.getAttribute('data-id'));
                        if (checked) UA_SELECTED.add(id); else UA_SELECTED.delete(id);
                    });
                };
                // Show modal
                UA_MODAL = new bootstrap.Modal(document.getElementById('userAssetsModal'));
                UA_MODAL.show();
            } catch (e) {
                alert('Failed to load assets: ' + e.message);
            }
        }

        async function bulkDeleteSelectedUserAssets() {
            if (UA_SELECTED.size === 0) return;
            if (!confirm(`Delete ${UA_SELECTED.size} selected assets?`)) return;
            try {
                const r = await fetch('/api/assets/bulk-delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ids: Array.from(UA_SELECTED) })
                });
                const j = await r.json();
                if (!j.success) throw new Error(j.error || 'Failed');
                alert(`Deleted ${j.deleted} assets`);
                // Refresh modal listing by closing and reopening
                UA_MODAL.hide();
            } catch (e) {
                alert('Bulk delete failed: ' + e.message);
            }
        }
    </script>
</body>
</html>
